<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipboard Fire Response Training - Complete DCA Training System</title>
    <script src="../dca-feedback-integration.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2980b9 0%, #6bb6ff 50%, #3742fa 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .training-modes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .mode-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            text-decoration: none;
            color: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .mode-card:hover {
            background: rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .mode-icon {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .mode-title {
            font-size: 1.8rem;
            margin-bottom: 15px;
            text-align: center;
            color: #ffd700;
        }
        
        .mode-description {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .mode-features {
            list-style: none;
            padding: 0;
        }
        
        .mode-features li {
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
        }
        
        .mode-features li::before {
            content: "‚úÖ";
            position: absolute;
            left: 0;
        }
        
        .mode-badge {
            display: inline-block;
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-top: 15px;
        }
        
        .training-content {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            display: none;
        }
        
        .training-content.active {
            display: block;
        }

        .question-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .question-header {
            font-size: 1.4rem;
            color: #ffd700;
            margin-bottom: 15px;
        }

        .question-text {
            font-size: 1.2rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .options-list {
            list-style: none;
            padding: 0;
        }

        .option-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .option-item.selected {
            background: rgba(52, 152, 219, 0.3);
            border-color: #3498db;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            height: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            height: 100%;
            transition: width 0.3s ease;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
        }

        .nav-btn {
            background: linear-gradient(45deg, #2980b9, #3498db);
            border: none;
            border-radius: 25px;
            color: white;
            padding: 12px 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
            text-decoration: none;
        }

        .nav-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .nav-btn:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
        }

        .results-card {
            text-align: center;
            padding: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }

        .score-display {
            font-size: 3rem;
            margin: 20px 0;
            color: #2ecc71;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .feedback-message {
            font-size: 1.2rem;
            line-height: 1.6;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .scenario-context {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scenario-title {
            color: #ffd700;
            margin-bottom: 10px;
            font-size: 1.6rem;
        }

        .scenario-description {
            font-size: 1.1rem;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
        }

        .assessment-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .ai-assessment {
            margin-top: 20px;
            padding: 20px;
            background: rgba(41, 128, 185, 0.2);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .assessment-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }

        .metric-label {
            font-weight: bold;
            color: #ffd700;
        }

        .metric-value {
            color: #2ecc71;
        }

        .resources {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî• Shipboard Fire Response Training</h1>
            <p>Comprehensive Damage Control Assistant Training System</p>
            <p>AI-Powered Scenario Analysis & Assessment Platform</p>
        </div>

        <div id="modeSelection" class="training-modes">
            <div class="mode-card" onclick="startScenarioMode()">
                <div class="mode-icon">üéØ</div>
                <div class="mode-title">Scenario Analysis</div>
                <div class="mode-description">
                    AI-powered fire scenario predictions using advanced DQN neural network
                </div>
                <ul class="mode-features">
                    <li>Interactive fire scenarios</li>
                    <li>DQN AI predictions</li>
                    <li>Confidence analysis</li>
                    <li>Success probability metrics</li>
                </ul>
                <div class="mode-badge">DQN + AWS Lambda</div>
            </div>

            <div class="mode-card" onclick="startAssessmentMode()">
                <div class="mode-icon">üìã</div>
                <div class="mode-title">DCA Assessment</div>
                <div class="mode-description">
                    Scenario-based training with Mistral-7B AI evaluation
                </div>
                <ul class="mode-features">
                    <li>AI-powered response analysis</li>
                    <li>Real-time decision assessment</li>
                    <li>Comprehensive scenario coverage</li>
                    <li>Performance confidence metrics</li>
                </ul>
                <div class="mode-badge">Mistral-7B + HuggingFace</div>
            </div>
        </div>

        <div id="assessmentContent" class="training-content">
            <!-- Assessment content will be dynamically inserted here -->
        </div>
    </div>

    <script>
        // Global Configuration
        const HF_API_KEY = ''; // REMOVED - Add your API key for local testing
        const MODEL_URL = 'https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.1';
        const AI_FEEDBACK_ENABLED = true;
        const USE_MOCK_DATA = false;
        const DQN_API_URL = 'http://localhost:5000/api';

        // Global State
        let currentMode = 'selection';
        let currentQuestionIndex = 0;
        let score = 0;
        let selectedAnswer = null;
        let assessmentQuestions = [];
        let dqnAgent = null;
        let scenarioGenerator = null;

        // Initialize DQN and Scenario Generator
        async function initializeAI() {
            try {
                // Initialize DQN Agent
                const response = await fetch(`${DQN_API_URL}/init_agent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const agentData = await response.json();
                dqnAgent = agentData.agent_id;
                
                // Initialize Scenario Generator
                const genResponse = await fetch(`${DQN_API_URL}/init_scenario_generator`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const genData = await genResponse.json();
                scenarioGenerator = genData.generator_id;
                
                console.log('ü§ñ AI components initialized');
                return true;
            } catch (error) {
                console.error('AI initialization failed:', error);
                return false;
            }
        }

        // Generate Dynamic Scenario
        async function generateScenario() {
            try {
                const response = await fetch(`${DQN_API_URL}/generate_scenario`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        generator_id: scenarioGenerator,
                        difficulty: 'medium'
                    })
                });
                return await response.json();
            } catch (error) {
                console.error('Scenario generation failed:', error);
                return null;
            }
        }

        // Evaluate Response using DQN
        async function evaluateResponse(scenario, question, selectedAnswer) {
            try {
                const response = await fetch(`${DQN_API_URL}/evaluate_response`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agent_id: dqnAgent,
                        scenario: scenario,
                        question: question,
                        response: selectedAnswer
                    })
                });
                return await response.json();
            } catch (error) {
                console.error('Response evaluation failed:', error);
                return null;
            }
        }

        // Assessment Data
        const SCENARIO_ASSESSMENT = {
            title: "DCA Comprehensive Assessment",
            description: "Test your knowledge of damage control and firefighting procedures through realistic scenarios",
            scenarios: [
                {
                    id: "initial_response",
                    title: "Initial Fire Response Scenario",
                    description: "You receive a report of smoke in the forward berthing area",
                    questions: [
                        {
                            id: "size_up",
                            question: "Smoke is reported in the forward berthing area. What should be your first three actions in order?",
                            options: [
                                "Sound general quarters, notify chain of command, dispatch investigation team",
                                "Evacuate the space, activate fire suppression, call damage control central",
                                "Verify smoke report, sound general quarters, set fire boundaries",
                                "Call for assistance, start ventilation, begin evacuation"
                            ],
                            correct: 0,
                            explanation: "Initial response requires immediate alert (GQ), command notification for decision-making authority, and investigation to assess the situation.",
                            resources: "Initial response procedures prioritize alert, command, and investigation"
                        },
                        {
                            id: "risk_assessment",
                            question: "The investigation team reports active fire in a mattress with moderate smoke. What is your primary concern?",
                            options: [
                                "Structural damage to bulkheads",
                                "Rapid fire spread through ventilation",
                                "Personnel evacuation and accountability",
                                "Water damage from firefighting"
                            ],
                            correct: 2,
                            explanation: "In berthing areas, personnel evacuation and accountability is the immediate priority due to life safety concerns.",
                            resources: "Life safety always takes precedence in occupied spaces"
                        }
                    ]
                },
                {
                    id: "fire_containment",
                    title: "Fire Containment Phase",
                    description: "Fire has been confirmed in the forward berthing with heavy smoke",
                    questions: [
                        {
                            id: "boundary_cooling",
                            question: "How should boundaries be established around the fire area?",
                            options: [
                                "One boundary immediately adjacent to the fire",
                                "Two boundaries with the primary at the fire and secondary one compartment out",
                                "Three boundaries with safe zones between each",
                                "Four boundaries creating multiple containment zones"
                            ],
                            correct: 1,
                            explanation: "Primary and secondary boundaries provide containment while allowing for tactical operations and safety zones.",
                            resources: "Proper boundary control prevents fire spread while enabling response"
                        },
                        {
                            id: "ventilation_strategy",
                            question: "What ventilation strategy should be implemented?",
                            options: [
                                "Maximize exhaust to remove smoke",
                                "Shut down all ventilation systems",
                                "Natural ventilation through opening hatches",
                                "Coordinate ventilation with fire attack plan"
                            ],
                            correct: 3,
                            explanation: "Ventilation must be coordinated with fire attack to prevent fire spread and support firefighting efforts.",
                            resources: "Ventilation affects fire behavior and firefighting effectiveness"
                        }
                    ]
                },
                {
                    id: "special_hazards",
                    title: "Special Hazards Response",
                    description: "Fire reported in the electronics equipment space with potential hazardous materials",
                    questions: [
                        {
                            id: "hazmat_identification",
                            question: "You identify lithium batteries in the fire area. What special considerations must be addressed?",
                            options: [
                                "Use standard water fire suppression",
                                "Only use CO2 extinguishers",
                                "Consider Class D extinguishing agents and establish battery cooling protocol",
                                "Immediately flood the space"
                            ],
                            correct: 2,
                            explanation: "Lithium battery fires require specific extinguishing agents and prolonged cooling to prevent thermal runaway.",
                            resources: "Special hazards require specific tactical approaches"
                        },
                        {
                            id: "electrical_safety",
                            question: "With energized electrical equipment involved, what protective measures are required?",
                            options: [
                                "Standard turnout gear is sufficient",
                                "Non-conductive gloves and tools, verify power isolation",
                                "Wait for complete power loss before entry",
                                "Use water fog pattern only"
                            ],
                            correct: 1,
                            explanation: "Electrical hazards require specific PPE and verification of power isolation while maintaining readiness to respond.",
                            resources: "Electrical fire safety protocols protect responders"
                        }
                    ]
                },
                {
                    id: "multi_space_fire",
                    title: "Multi-Space Fire Scenario",
                    description: "Fire has spread from initial compartment to adjacent spaces",
                    questions: [
                        {
                            id: "resource_allocation",
                            question: "With fire in three adjacent compartments, how should teams be deployed?",
                            options: [
                                "Equal resources to all three spaces",
                                "Focus all resources on the most severe area",
                                "Establish primary attack on point of origin, containment teams on spread",
                                "Wait for additional resources before engaging"
                            ],
                            correct: 2,
                            explanation: "Primary attack at origin while containing spread prevents further extension and allows systematic extinguishment.",
                            resources: "Resource allocation affects overall fire control"
                        },
                        {
                            id: "communication_coordination",
                            question: "How should communications be managed between multiple attack teams?",
                            options: [
                                "Each team on separate frequencies",
                                "All teams monitor all communications",
                                "Designated command channel and tactical channels",
                                "Teams communicate through relay personnel only"
                            ],
                            correct: 2,
                            explanation: "Separate command and tactical channels maintain clear communication while preventing radio confusion.",
                            resources: "Effective communication crucial in complex scenarios"
                        },
                        {
                            id: "strategic_priorities",
                            question: "What is the priority when fire threatens critical ship systems in multiple spaces?",
                            options: [
                                "Protect all systems equally",
                                "Focus on highest value system only",
                                "Establish protection for critical systems while containing fire spread",
                                "Evacuate all spaces and use fixed systems"
                            ],
                            correct: 2,
                            explanation: "Protecting critical systems while maintaining overall fire control preserves ship capabilities.",
                            resources: "Strategic priorities balance ship survival needs"
                        }
                    ]
                }
            ]
        };

        // Function to show mode selection screen
        function showModeSelection() {
            document.getElementById('modeSelection').style.display = 'grid';
            document.getElementById('assessmentContent').classList.remove('active');
            currentMode = 'selection';
        }

        // Function to start scenario mode
        function startScenarioMode() {
            window.location.href = './index.html';
        }

        // Function to start assessment mode
        async function startAssessmentMode() {
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('assessmentContent').classList.add('active');
            currentMode = 'assessment';
            
            // Initialize AI components before starting
            const aiInitialized = await initializeAI();
            if (aiInitialized) {
                initializeAssessment();
            } else {
                alert('Failed to initialize AI components. Using fallback mode.');
                initializeAssessment(true);
            }
        }

        // Function to initialize assessment
        async function initializeAssessment(useFallback = false) {
            currentQuestionIndex = 0;
            score = 0;
            selectedAnswer = null;
            
            if (!useFallback) {
                try {
                    // Generate dynamic scenarios
                    const generatedScenarios = [];
                    for (let i = 0; i < 3; i++) {
                        const scenario = await generateScenario();
                        if (scenario) {
                            generatedScenarios.push(scenario);
                        }
                    }
                    
                    if (generatedScenarios.length > 0) {
                        assessmentQuestions = generatedScenarios.flatMap(scenario => 
                            scenario.questions.map(q => ({
                                ...q,
                                scenario: scenario.title,
                                scenarioDescription: scenario.description,
                                scenarioContext: scenario.context,
                                difficulty: scenario.difficulty,
                                evaluationMetrics: scenario.metrics
                            }))
                        );
                    } else {
                        useFallback = true;
                    }
                } catch (error) {
                    console.error('Failed to generate scenarios:', error);
                    useFallback = true;
                }
            }
            
            if (useFallback) {
                // Fallback to predefined scenarios
                assessmentQuestions = SCENARIO_ASSESSMENT.scenarios.reduce((acc, scenario) => {
                    return acc.concat(scenario.questions.map(q => ({...q, scenario: scenario.title})));
                }, []);
            }

            // Shuffle questions
            assessmentQuestions = shuffleArray(assessmentQuestions);
            
            // Start feedback session
            if (window.startDCAFeedbackSession) {
                window.startDCAFeedbackSession({
                    id: 'assessment_' + Date.now(),
                    type: 'comprehensive',
                    mode: useFallback ? 'fallback' : 'ai_enhanced'
                });
            }

            showCurrentQuestion();
        }

        // Function to shuffle array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Function to show current question
        function showCurrentQuestion() {
            const question = assessmentQuestions[currentQuestionIndex];
            const content = document.getElementById('assessmentContent');
            
            // For dynamically generated scenarios, use the scenario data directly
            const scenario = {
                title: question.scenario,
                description: question.scenarioDescription || '',
                context: question.scenarioContext || {}
            };
            
            content.innerHTML = `
                <div class="question-card">
                    <div class="scenario-context">
                        <h2 class="scenario-title">${scenario.title}</h2>
                        <p class="scenario-description">${scenario.description}</p>
                    </div>
                    
                    <div class="assessment-section">
                        <h3 class="question-header">Question ${currentQuestionIndex + 1} of ${assessmentQuestions.length}</h3>
                        <p class="question-text">${question.question}</p>
                        
                        <ul class="options-list">
                            ${question.options.map((option, index) => `
                                <li class="option-item${selectedAnswer === index ? ' selected' : ''}" 
                                    onclick="selectAnswer(${index})">
                                    ${option}
                                </li>
                            `).join('')}
                        </ul>
                        
                        ${selectedAnswer !== null ? `
                            <div class="ai-assessment">
                                <h4>AI Assessment</h4>
                                <p>${question.explanation}</p>
                                <div class="assessment-metrics">
                                    <div class="metric">
                                        <span class="metric-label">Decision Confidence:</span>
                                        <span class="metric-value">85%</span>
                                    </div>
                                    <div class="metric">
                                        <span class="metric-label">Safety Impact:</span>
                                        <span class="metric-value">High</span>
                                    </div>
                                    <div class="metric">
                                        <span class="metric-label">Response Time:</span>
                                        <span class="metric-value">Critical</span>
                                    </div>
                                </div>
                                <p class="resources"><strong>Resources:</strong> ${question.resources}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <div class="progress-section">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${(currentQuestionIndex + 1) / assessmentQuestions.length * 100}%"></div>
                    </div>
                    <div class="nav-buttons">
                        <button class="nav-btn" onclick="previousQuestion()" 
                                ${currentQuestionIndex === 0 ? 'disabled' : ''}>
                            ‚Üê Previous
                        </button>
                        <button class="nav-btn" onclick="submitAnswer()" 
                                ${selectedAnswer === null ? 'disabled' : ''}>
                            ${currentQuestionIndex === assessmentQuestions.length - 1 ? 'Finish' : 'Next ‚Üí'}
                        </button>
                    </div>
                </div>
            `;
        }

        // Function to select an answer
        function selectAnswer(index) {
            selectedAnswer = index;
            showCurrentQuestion();
        }

        // Function to show previous question
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                selectedAnswer = null;
                showCurrentQuestion();
            }
        }

        // Function to submit answer and move to next question
        async function submitAnswer() {
            const currentQuestion = assessmentQuestions[currentQuestionIndex];
            const selectedOption = currentQuestion.options[selectedAnswer];
            
            try {
                // Send to DQN API for evaluation
                const response = await fetch('http://localhost:5000/evaluate_response', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        scenario: currentQuestion.scenario,
                        question: currentQuestion.question,
                        selected_response: selectedOption,
                        context: {
                            phase: currentQuestion.scenario,
                            question_type: currentQuestion.id
                        }
                    })
                });

                const aiEvaluation = await response.json();
                
                // Store AI feedback for this question
                currentQuestion.aiFeedback = aiEvaluation.feedback;
                currentQuestion.aiConfidence = aiEvaluation.confidence;
                currentQuestion.aiRecommendation = aiEvaluation.recommendation;
                
                // Update score based on both correct answer and AI evaluation
                if (selectedAnswer === currentQuestion.correct) {
                    score++;
                }

            } catch (error) {
                console.error('AI Evaluation Error:', error);
                // Fallback to basic scoring if AI evaluation fails
                if (selectedAnswer === currentQuestion.correct) {
                    score++;
                }
            }

            if (currentQuestionIndex === assessmentQuestions.length - 1) {
                showResults();
            } else {
                currentQuestionIndex++;
                selectedAnswer = null;
                showCurrentQuestion();
            }
        }

        // Function to get AI assessment
        async function getAIAssessment(performance) {
            const prompt = `As a Damage Control Assistant (DCA) training evaluator, analyze this performance:
            Score: ${performance.score}%
            Correct Answers: ${performance.correct} out of ${performance.questions}
            Areas Tested: ${performance.areas.join(', ')}
            
            Provide a brief, professional assessment of their readiness and specific areas for improvement.`;

            try {
                const response = await fetch(MODEL_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${HF_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ inputs: prompt })
                });

                const result = await response.json();
                return result[0].generated_text || "AI assessment unavailable at this time.";
            } catch (error) {
                console.error('AI Assessment Error:', error);
                return "AI assessment unavailable at this time.";
            }
        }

        // Function to show results
        async function showResults() {
            const percentage = Math.round(score / assessmentQuestions.length * 100);
            const content = document.getElementById('assessmentContent');
            
            try {
                // Get final AI analysis from DQN
                const response = await fetch('http://localhost:5000/analyze_performance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        score: percentage,
                        questions: assessmentQuestions.map(q => ({
                            scenario: q.scenario,
                            question: q.question,
                            selected_answer: q.options[selectedAnswer],
                            correct: q.correct === selectedAnswer,
                            ai_feedback: q.aiFeedback,
                            ai_confidence: q.aiConfidence
                        }))
                    })
                });

                const aiAnalysis = await response.json();
                
                content.innerHTML = `
                    <div class="results-card">
                        <h2>Assessment Complete</h2>
                        <div class="score-display">${percentage}%</div>
                        <p>You answered ${score} out of ${assessmentQuestions.length} questions correctly</p>
                        
                        <div class="ai-feedback">
                            <h3>AI Performance Analysis</h3>
                            <p><strong>Overall Assessment:</strong> ${aiAnalysis.overall_assessment}</p>
                            <p><strong>Decision Making Confidence:</strong> ${aiAnalysis.decision_confidence}%</p>
                            <p><strong>Areas of Strength:</strong> ${aiAnalysis.strengths.join(', ')}</p>
                            <p><strong>Areas for Improvement:</strong> ${aiAnalysis.improvement_areas.join(', ')}</p>
                            <p><strong>Recommendations:</strong> ${aiAnalysis.recommendations}</p>
                            
                            <h4>Scenario-Specific Feedback:</h4>
                            ${Object.entries(aiAnalysis.scenario_feedback).map(([scenario, feedback]) => `
                                <div class="scenario-feedback">
                                    <strong>${scenario}:</strong> ${feedback}
                                </div>
                            `).join('')}
                        </div>

                        <div class="nav-buttons">
                            <button class="nav-btn" onclick="startAssessmentMode()">Try Again</button>
                            <button class="nav-btn" onclick="showModeSelection()">Return to Menu</button>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('AI Analysis Error:', error);
                // Fallback to basic results if AI analysis fails
                content.innerHTML = `
                    <div class="results-card">
                        <h2>Assessment Complete</h2>
                        <div class="score-display">${percentage}%</div>
                        <p>You answered ${score} out of ${assessmentQuestions.length} questions correctly</p>
                        <p class="feedback-message">${getFeedbackMessage(percentage)}</p>
                        <div class="nav-buttons">
                            <button class="nav-btn" onclick="startAssessmentMode()">Try Again</button>
                            <button class="nav-btn" onclick="showModeSelection()">Return to Menu</button>
                        </div>
                    </div>
                `;
            }

            // Try to send feedback in the background
            try {
                if (window.completeDCAFeedbackSession) {
                    window.completeDCAFeedbackSession({
                        score: percentage,
                        questions: assessmentQuestions.length,
                        correct: score
                    });
                }
            } catch (error) {
                console.log('Feedback system not available:', error);
            }
        }
        
        // Helper function to get feedback message based on score
        function getFeedbackMessage(percentage) {
            if (percentage >= 90) {
                return "Outstanding performance! You've demonstrated excellent understanding of DCA procedures and protocols.";
            } else if (percentage >= 75) {
                return "Great job! You show strong knowledge of damage control procedures with some room for refinement.";
            } else if (percentage >= 60) {
                return "Good effort! Consider reviewing the areas where you had difficulty to strengthen your knowledge.";
            } else {
                return "This is a good starting point. Focus on reviewing the core concepts and try again to improve your score.";
            }
        }

        // Function to show help
        function showHelp() {
            alert('Help and instructions coming soon!');
        }

        // Initialize feedback system if available
        window.addEventListener('load', function() {
            if (window.dcaFeedback) {
                window.dcaFeedback = new DCAFeedbackManager();
                console.log('üî• DCA Feedback system initialized');
            }
        });

        // Initialize to mode selection on load
        showModeSelection();
    </script>
</body>
</html>
