<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipboard Fire Response Training - Complete DCA Training System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2980b9 0%, #6bb6ff 50%, #3742fa 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .training-modes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .mode-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            text-decoration: none;
            color: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .mode-card:hover {
            background: rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .mode-icon {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .mode-title {
            font-size: 1.8rem;
            margin-bottom: 15px;
            text-align: center;
            color: #ffd700;
        }
        
        .mode-description {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .mode-features {
            list-style: none;
            padding: 0;
        }
        
        .mode-features li {
            padding: 5px 0;
        }
        
        /* DCA Assessment Styles */
        .dca-assessment {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .question-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .question-text {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #ffd700;
        }
        
        .choices-container {
            display: grid;
            gap: 15px;
        }
        
        .choice-option {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }
        
        .choice-option:hover {
            background: rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.4);
        }
        
        .choice-option input[type="radio"] {
            margin-right: 15px;
            width: 20px;
            height: 20px;
        }
        
        .choice-option label {
            flex-grow: 1;
            cursor: pointer;
        }
        
        .consequence-message {
            background: rgba(255, 193, 7, 0.2);
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-top: 20px;
            border-radius: 0 8px 8px 0;
        }
        
        .consequence-message.success {
            background: rgba(40, 167, 69, 0.2);
            border-left-color: #28a745;
        }
        
        .consequence-message.warning {
            background: rgba(220, 53, 69, 0.2);
            border-left-color: #dc3545;
        }
            padding-left: 20px;
            position: relative;
        }
        
        .mode-features li::before {
            content: "‚úÖ";
            position: absolute;
            left: 0;
        }
        
        .mode-badge {
            display: inline-block;
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-top: 15px;
        }
        
        .training-content {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            display: none;
        }
        
        /* Scenario Information */
        .scenario-info {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .scenario-title {
            font-size: 1.5rem;
            color: #ffd700;
            margin-bottom: 10px;
        }
        
        .scenario-description {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .scenario-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        
        .detail-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .detail-label {
            font-weight: bold;
            color: #ffd700;
        }
        }
        
        .training-content.active {
            display: block;
        }

        .question-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .question-header {
            font-size: 1.4rem;
            color: #ffd700;
            margin-bottom: 15px;
        }

        .question-text {
            font-size: 1.2rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .options-list {
            list-style: none;
            padding: 0;
        }

        .option-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .option-item.selected {
            background: rgba(52, 152, 219, 0.3);
            border-color: #3498db;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            height: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            height: 100%;
            transition: width 0.3s ease;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
        }

        .nav-btn {
            background: linear-gradient(45deg, #2980b9, #3498db);
            border: none;
            border-radius: 25px;
            color: white;
            padding: 12px 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
            text-decoration: none;
        }

        .nav-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .nav-btn:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
        }

        .results-card {
            text-align: center;
            padding: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }

        .score-display {
            font-size: 3rem;
            margin: 20px 0;
            color: #2ecc71;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .feedback-message {
            font-size: 1.2rem;
            line-height: 1.6;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .scenario-context {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scenario-title {
            color: #ffd700;
            margin-bottom: 10px;
            font-size: 1.6rem;
        }

        .scenario-description {
            font-size: 1.1rem;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
        }

        .assessment-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .ai-assessment {
            margin-top: 20px;
            padding: 20px;
            background: rgba(41, 128, 185, 0.2);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .assessment-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }

        .metric-label {
            font-weight: bold;
            color: #ffd700;
        }

        .metric-value {
            color: #2ecc71;
        }

        .resources {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî• Shipboard Fire Response Training</h1>
            <p>Comprehensive Damage Control Assistant Training System</p>
            <p>AI-Powered Scenario Analysis & Assessment Platform</p>
        </div>

        <div id="modeSelection" class="training-modes">
            <div class="mode-card" onclick="startScenarioMode()">
                <div class="mode-icon">üéØ</div>
                <div class="mode-title">Scenario Analysis</div>
                <div class="mode-description">
                    AI-powered fire scenario predictions using advanced DQN neural network
                </div>
                <ul class="mode-features">
                    <li>Interactive fire scenarios</li>
                    <li>DQN AI predictions</li>
                    <li>Confidence analysis</li>
                    <li>Success probability metrics</li>
                </ul>
                <div class="mode-badge">DQN + AWS Lambda</div>
            </div>

            <div class="mode-card" onclick="startAssessmentMode()">
                <div class="mode-icon">üìã</div>
                <div class="mode-title">DCA Assessment</div>
                <div class="mode-description">
                    Scenario-based training with Mistral-7B AI evaluation
                </div>
                <ul class="mode-features">
                    <li>AI-powered response analysis</li>
                    <li>Real-time decision assessment</li>
                    <li>Comprehensive scenario coverage</li>
                    <li>Performance confidence metrics</li>
                </ul>
                <div class="mode-badge">Mistral-7B + HuggingFace</div>
            </div>
        </div>

        <div id="assessmentContent" class="training-content">
            <!-- Assessment content will be dynamically inserted here -->
        </div>
    </div>

    <script>
        // Global Configuration
        const HF_API_KEY = ''; // REMOVED - Add your API key for local testing
        const MODEL_URL = 'https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.1';
        const AI_FEEDBACK_ENABLED = false;
        const USE_MOCK_DATA = false;

        // Global State
        let currentMode = 'selection';
        let currentQuestionIndex = 0;
        let score = 0;
        let selectedAnswer = null;
        let assessmentQuestions = [];
        let questionStartTime = null;
        let responseTime = 0;

        // Assessment Data
        const SCENARIO_ASSESSMENT = {
            title: "DCA Comprehensive Assessment",
            description: "Test your knowledge of damage control and firefighting procedures through realistic scenarios",
            scenarios: [
                {
                    id: "initial_response",
                    title: "Initial Fire Response Scenario",
                    description: "You receive a report of smoke in the forward berthing area",
                    questions: [
                        {
                            id: "size_up",
                            question: "Smoke is reported in the forward berthing area. What should be your first three actions in order?",
                            options: [
                                "Sound general quarters, notify chain of command, dispatch investigation team",
                                "Evacuate the space, activate fire suppression, call damage control central",
                                "Verify smoke report, sound general quarters, set fire boundaries",
                                "Call for assistance, start ventilation, begin evacuation"
                            ],
                            correct: 0,
                            explanation: "Initial response requires immediate alert (GQ), command notification for decision-making authority, and investigation to assess the situation.",
                            resources: "Initial response procedures prioritize alert, command, and investigation"
                        },
                        {
                            id: "risk_assessment",
                            question: "The investigation team reports active fire in a mattress with moderate smoke. What is your primary concern?",
                            options: [
                                "Structural damage to bulkheads",
                                "Rapid fire spread through ventilation",
                                "Personnel evacuation and accountability",
                                "Water damage from firefighting"
                            ],
                            correct: 2,
                            explanation: "In berthing areas, personnel evacuation and accountability is the immediate priority due to life safety concerns.",
                            resources: "Life safety always takes precedence in occupied spaces"
                        }
                    ]
                },
                {
                    id: "fire_containment",
                    title: "Fire Containment Phase",
                    description: "Fire has been confirmed in the forward berthing with heavy smoke",
                    questions: [
                        {
                            id: "boundary_cooling",
                            question: "How should boundaries be established around the fire area?",
                            options: [
                                "One boundary immediately adjacent to the fire",
                                "Two boundaries with the primary at the fire and secondary one compartment out",
                                "Three boundaries with safe zones between each",
                                "Four boundaries creating multiple containment zones"
                            ],
                            correct: 1,
                            explanation: "Primary and secondary boundaries provide containment while allowing for tactical operations and safety zones.",
                            resources: "Proper boundary control prevents fire spread while enabling response"
                        },
                        {
                            id: "ventilation_strategy",
                            question: "What ventilation strategy should be implemented?",
                            options: [
                                "Maximize exhaust to remove smoke",
                                "Shut down all ventilation systems",
                                "Natural ventilation through opening hatches",
                                "Coordinate ventilation with fire attack plan"
                            ],
                            correct: 3,
                            explanation: "Ventilation must be coordinated with fire attack to prevent fire spread and support firefighting efforts.",
                            resources: "Ventilation affects fire behavior and firefighting effectiveness"
                        }
                    ]
                },
                {
                    id: "special_hazards",
                    title: "Special Hazards Response",
                    description: "Fire reported in the electronics equipment space with potential hazardous materials",
                    questions: [
                        {
                            id: "hazmat_identification",
                            question: "You identify lithium batteries in the fire area. What special considerations must be addressed?",
                            options: [
                                "Use standard water fire suppression",
                                "Only use CO2 extinguishers",
                                "Consider Class D extinguishing agents and establish battery cooling protocol",
                                "Immediately flood the space"
                            ],
                            correct: 2,
                            explanation: "Lithium battery fires require specific extinguishing agents and prolonged cooling to prevent thermal runaway.",
                            resources: "Special hazards require specific tactical approaches"
                        },
                        {
                            id: "electrical_safety",
                            question: "With energized electrical equipment involved, what protective measures are required?",
                            options: [
                                "Standard turnout gear is sufficient",
                                "Non-conductive gloves and tools, verify power isolation",
                                "Wait for complete power loss before entry",
                                "Use water fog pattern only"
                            ],
                            correct: 1,
                            explanation: "Electrical hazards require specific PPE and verification of power isolation while maintaining readiness to respond.",
                            resources: "Electrical fire safety protocols protect responders"
                        }
                    ]
                },
                {
                    id: "multi_space_fire",
                    title: "Multi-Space Fire Scenario",
                    description: "Fire has spread from initial compartment to adjacent spaces",
                    questions: [
                        {
                            id: "resource_allocation",
                            question: "With fire in three adjacent compartments, how should teams be deployed?",
                            options: [
                                "Equal resources to all three spaces",
                                "Focus all resources on the most severe area",
                                "Establish primary attack on point of origin, containment teams on spread",
                                "Wait for additional resources before engaging"
                            ],
                            correct: 2,
                            explanation: "Primary attack at origin while containing spread prevents further extension and allows systematic extinguishment.",
                            resources: "Resource allocation affects overall fire control"
                        },
                        {
                            id: "communication_coordination",
                            question: "How should communications be managed between multiple attack teams?",
                            options: [
                                "Each team on separate frequencies",
                                "All teams monitor all communications",
                                "Designated command channel and tactical channels",
                                "Teams communicate through relay personnel only"
                            ],
                            correct: 2,
                            explanation: "Separate command and tactical channels maintain clear communication while preventing radio confusion.",
                            resources: "Effective communication crucial in complex scenarios"
                        },
                        {
                            id: "strategic_priorities",
                            question: "What is the priority when fire threatens critical ship systems in multiple spaces?",
                            options: [
                                "Protect all systems equally",
                                "Focus on highest value system only",
                                "Establish protection for critical systems while containing fire spread",
                                "Evacuate all spaces and use fixed systems"
                            ],
                            correct: 2,
                            explanation: "Protecting critical systems while maintaining overall fire control preserves ship capabilities.",
                            resources: "Strategic priorities balance ship survival needs"
                        }
                    ]
                }
            ]
        };

        // Function to show mode selection screen
        function showModeSelection() {
            document.getElementById('modeSelection').style.display = 'grid';
            document.getElementById('assessmentContent').classList.remove('active');
            currentMode = 'selection';
        }

        // Function to start scenario mode
        function startScenarioMode() {
            window.location.href = './index.html';
        }

        // Function to start assessment mode
        function startAssessmentMode() {
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('assessmentContent').classList.add('active');
            currentMode = 'assessment';
            initializeAssessment();
        }

        // Function to initialize assessment
        function initializeAssessment() {
            currentQuestionIndex = 0;
            score = 0;
            selectedAnswer = null;
            
            // Flatten questions from all scenarios
            assessmentQuestions = SCENARIO_ASSESSMENT.scenarios.reduce((acc, scenario) => {
                return acc.concat(scenario.questions.map(q => ({...q, scenario: scenario.title})));
            }, []);

            // Shuffle questions and limit to 10 for demo
            assessmentQuestions = shuffleArray(assessmentQuestions).slice(0, 10);
            
            showCurrentQuestion();
        }

        // Function to shuffle array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Function to show current question
        function showCurrentQuestion() {
            // Only show questions if we're in assessment mode
            if (currentMode !== 'assessment') {
                console.log('showCurrentQuestion called but not in assessment mode');
                return;
            }
            
            // Make sure we have questions and a valid index
            if (!assessmentQuestions || assessmentQuestions.length === 0 || currentQuestionIndex >= assessmentQuestions.length) {
                console.log('No valid questions to show');
                return;
            }
            
            const question = assessmentQuestions[currentQuestionIndex];
            const content = document.getElementById('assessmentContent');
            
            // Start timing for this question
            questionStartTime = Date.now();
            
            // Find the parent scenario for this question
            const scenario = SCENARIO_ASSESSMENT.scenarios.find(s => 
                s.questions.some(q => q.id === question.id)
            );
            
            content.innerHTML = `
                <div class="question-card">
                    <div class="scenario-context">
                        <h2 class="scenario-title">${scenario.title}</h2>
                        <p class="scenario-description">${scenario.description}</p>
                    </div>
                    
                    <div class="assessment-section">
                        <h3 class="question-header">Question ${currentQuestionIndex + 1} of ${assessmentQuestions.length}</h3>
                        <p class="question-text">${question.question}</p>
                        
                        <ul class="options-list">
                            ${question.options.map((option, index) => `
                                <li class="option-item${selectedAnswer === index ? ' selected' : ''}" 
                                    onclick="selectAnswer(${index})">
                                    ${option}
                                </li>
                            `).join('')}
                        </ul>
                        
                        ${selectedAnswer !== null ? `
                            <div class="ai-assessment">
                                <h4>AI Assessment</h4>
                                <p>${question.explanation}</p>
                                <div class="assessment-metrics">
                                    <div class="metric">
                                        <span class="metric-label">Decision Confidence:</span>
                                        <span class="metric-value">85%</span>
                                    </div>
                                    <div class="metric">
                                        <span class="metric-label">Safety Impact:</span>
                                        <span class="metric-value">High</span>
                                    </div>
                                    <div class="metric">
                                        <span class="metric-label">Response Time:</span>
                                        <span class="metric-value">Critical</span>
                                    </div>
                                </div>
                                <p class="resources"><strong>Resources:</strong> ${question.resources}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <div class="progress-section">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${(currentQuestionIndex + 1) / assessmentQuestions.length * 100}%"></div>
                    </div>
                    <div class="nav-buttons">
                        <button class="nav-btn" onclick="previousQuestion()" 
                                ${currentQuestionIndex === 0 ? 'disabled' : ''}>
                            ‚Üê Previous
                        </button>
                        <button class="nav-btn" onclick="submitAnswer()" 
                                ${selectedAnswer === null ? 'disabled' : ''}>
                            ${currentQuestionIndex === assessmentQuestions.length - 1 ? 'Finish' : 'Next ‚Üí'}
                        </button>
                    </div>
                </div>
            `;
        }

        // Function to select an answer
        function selectAnswer(index) {
            selectedAnswer = index;
            showCurrentQuestion();
        }

        // Function to show previous question
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                selectedAnswer = null;
                showCurrentQuestion();
            }
        }

        // Function to submit answer and move to next question
        async function submitAnswer() {
            // Check if an answer is selected
            if (selectedAnswer === null) {
                alert('Please select an answer before submitting.');
                return;
            }
            
            const currentQuestion = assessmentQuestions[currentQuestionIndex];
            const selectedOption = currentQuestion.options[selectedAnswer];
            
            // Calculate response time (in seconds)
            responseTime = questionStartTime ? (Date.now() - questionStartTime) / 1000 : 30;
            
            try {
                console.log('Submitting answer:', {
                    scenario: currentQuestion.scenario,
                    question: currentQuestion.question,
                    selected_response: selectedOption,
                    response_time_ms: responseTime * 1000,
                    is_correct: selectedAnswer === currentQuestion.correct
                });
                
                // Send to DQN API for evaluation
                const response = await fetch('/api/dca-evaluate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        scenario: currentQuestion.scenario,
                        question: currentQuestion.question,
                        selected_response: selectedOption,
                        response_time_ms: responseTime * 1000,
                        is_correct: selectedAnswer === currentQuestion.correct
                    })
                });

                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const aiEvaluation = await response.json();
                console.log('AI Evaluation received:', aiEvaluation);
                
                // Store AI feedback for this question
                currentQuestion.aiFeedback = aiEvaluation.feedback;
                currentQuestion.aiConfidence = aiEvaluation.confidence;
                currentQuestion.aiRecommendation = aiEvaluation.recommendation;
                
                // Update score based on both correct answer and AI evaluation
                if (selectedAnswer === currentQuestion.correct) {
                    score++;
                }

            } catch (error) {
                console.error('AI Evaluation Error:', error);
                alert('API Error: ' + error.message + '. Using basic scoring instead.');
                // Fallback to basic scoring if AI evaluation fails
                if (selectedAnswer === currentQuestion.correct) {
                    score++;
                }
            }

            if (currentQuestionIndex === assessmentQuestions.length - 1) {
                showResults();
            } else {
                // Brief delay to show feedback, then advance
                setTimeout(() => {
                    currentQuestionIndex++;
                    selectedAnswer = null;
                    showCurrentQuestion();
                }, 1500);
            }
        }

        // Function to get AI assessment
        async function getAIAssessment(performance) {
            const prompt = `As a Damage Control Assistant (DCA) training evaluator, analyze this performance:
            Score: ${performance.score}%
            Correct Answers: ${performance.correct} out of ${performance.questions}
            Areas Tested: ${performance.areas.join(', ')}
            
            Provide a brief, professional assessment of their readiness and specific areas for improvement.`;

            try {
                // Simplified local assessment instead of Hugging Face API
                let assessment = "";
                if (performance.score >= 90) {
                    assessment = "Outstanding performance! You demonstrate excellent understanding of shipboard fire response procedures. Your decision-making is swift and accurate. Continue maintaining this high standard.";
                } else if (performance.score >= 80) {
                    assessment = "Very good performance. You show strong competency in fire response procedures with only minor areas for improvement. Focus on consistent application of protocols.";
                } else if (performance.score >= 70) {
                    assessment = "Good foundation in fire response procedures. Some areas need attention. Review emergency protocols and practice scenario decision-making to improve response times.";
                } else if (performance.score >= 60) {
                    assessment = "Basic understanding evident but significant improvement needed. Focus on fundamental fire response procedures, safety protocols, and emergency decision-making.";
                } else {
                    assessment = "Requires substantial improvement. Recommend comprehensive review of fire response procedures, safety protocols, and additional training scenarios.";
                }
                return assessment;
            } catch (error) {
                console.error('AI Assessment Error:', error);
                return "AI assessment unavailable at this time.";
            }
        }

        // Function to show results
        async function showResults() {
            const percentage = Math.round(score / assessmentQuestions.length * 100);
            const content = document.getElementById('assessmentContent');
            
            try {
                // Create mock AI analysis since we simplified the system
                const aiAnalysis = {
                    overall_assessment: percentage >= 80 ? "Excellent performance" : 
                                       percentage >= 70 ? "Good performance" : 
                                       percentage >= 60 ? "Satisfactory performance" : "Needs improvement",
                    decision_confidence: Math.min(95, percentage + 10),
                    scenario_feedback: {
                        "Fire Response": percentage >= 70 ? "Strong understanding of fire response procedures" : "Review fire response protocols",
                        "Emergency Management": percentage >= 70 ? "Good emergency decision making" : "Practice emergency scenarios",
                        "Safety Assessment": percentage >= 70 ? "Excellent safety awareness" : "Focus on safety procedures"
                    },
                    recommendations: percentage >= 70 ? 
                        ["Continue practicing complex scenarios", "Maintain current training level"] :
                        ["Review basic procedures", "Practice more scenarios", "Study safety protocols"]
                };
                
                content.innerHTML = `
                    <div class="results-card">
                        <h2>Assessment Complete</h2>
                        <div class="score-display">${percentage}%</div>
                        <p>You answered ${score} out of ${assessmentQuestions.length} questions correctly</p>
                        
                        <div class="ai-feedback">
                            <h3>AI Performance Analysis</h3>
                            <p><strong>Overall Assessment:</strong> ${aiAnalysis.overall_assessment}</p>
                            <p><strong>Decision Making Confidence:</strong> ${aiAnalysis.decision_confidence}%</p>
                            <p><strong>Areas of Strength:</strong> ${aiAnalysis.strengths.join(', ')}</p>
                            <p><strong>Areas for Improvement:</strong> ${aiAnalysis.improvement_areas.join(', ')}</p>
                            <p><strong>Recommendations:</strong> ${aiAnalysis.recommendations}</p>
                            
                            <h4>Scenario-Specific Feedback:</h4>
                            ${Object.entries(aiAnalysis.scenario_feedback).map(([scenario, feedback]) => `
                                <div class="scenario-feedback">
                                    <strong>${scenario}:</strong> ${feedback}
                                </div>
                            `).join('')}
                        </div>

                        <div class="nav-buttons">
                            <button class="nav-btn" onclick="startAssessmentMode()">Try Again</button>
                            <button class="nav-btn" onclick="showModeSelection()">Return to Menu</button>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('AI Analysis Error:', error);
                // Fallback to basic results if AI analysis fails
                content.innerHTML = `
                    <div class="results-card">
                        <h2>Assessment Complete</h2>
                        <div class="score-display">${percentage}%</div>
                        <p>You answered ${score} out of ${assessmentQuestions.length} questions correctly</p>
                        <p class="feedback-message">${getFeedbackMessage(percentage)}</p>
                        <div class="nav-buttons">
                            <button class="nav-btn" onclick="startAssessmentMode()">Try Again</button>
                            <button class="nav-btn" onclick="showModeSelection()">Return to Menu</button>
                        </div>
                    </div>
                `;
            }

            // Try to send feedback in the background
            try {
                if (window.completeDCAFeedbackSession) {
                    window.completeDCAFeedbackSession({
                        score: percentage,
                        questions: assessmentQuestions.length,
                        correct: score
                    });
                }
            } catch (error) {
                console.log('Feedback system not available:', error);
            }
        }
        
        // Helper function to get feedback message based on score
        function getFeedbackMessage(percentage) {
            if (percentage >= 90) {
                return "Outstanding performance! You've demonstrated excellent understanding of DCA procedures and protocols.";
            } else if (percentage >= 75) {
                return "Great job! You show strong knowledge of damage control procedures with some room for refinement.";
            } else if (percentage >= 60) {
                return "Good effort! Consider reviewing the areas where you had difficulty to strengthen your knowledge.";
            } else {
                return "This is a good starting point. Focus on reviewing the core concepts and try again to improve your score.";
            }
        }

        // Function to show help
        function showHelp() {
            alert('Help and instructions coming soon!');
        }

        // Initialize feedback system if available
        window.addEventListener('load', function() {
            if (window.dcaFeedback) {
                window.dcaFeedback = new DCAFeedbackManager();
                console.log('üî• DCA Feedback system initialized');
            }
        });

        // Initialize to mode selection on load
        showModeSelection();
    </script>

    <!-- DCA Assessment Section -->
    <div class="dca-assessment" id="dcaAssessment">
        <!-- Scenario Information -->
        <div class="scenario-info">
            <h2 class="scenario-title">Current Scenario</h2>
            <p class="scenario-description" id="scenarioDescription">
                Loading scenario...
            </p>
            <div class="scenario-details">
                <div class="detail-item">
                    <span class="detail-label">Location:</span>
                    <span id="fireLocation">--</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Time Elapsed:</span>
                    <span id="timeElapsed">0:00</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Smoke Condition:</span>
                    <span id="smokeCondition">--</span>
                </div>
            </div>
        </div>

        <!-- Question Container -->
        <div class="question-container" id="questionContainer">
            <h3 class="question-text" id="questionText">Loading question...</h3>
            <div class="choices-container" id="choicesContainer">
                <!-- Choices will be dynamically inserted here -->
            </div>
        </div>

        <!-- Consequence Display -->
        <div id="consequenceContainer"></div>
    </div>

    <script>
        // DCA Assessment Handler - DISABLED (conflicts with main assessment)
        class DCAAssessmentHandler {
            constructor() {
                // DISABLED - this was conflicting with main assessment system
                // this.currentState = null;
                // this.currentQuestion = null;
                // this.bindElements();
                // this.initialize();
                console.log('DCAAssessmentHandler disabled - using main assessment system');
            }

            bindElements() {
                this.scenarioDescription = document.getElementById('scenarioDescription');
                this.fireLocation = document.getElementById('fireLocation');
                this.timeElapsed = document.getElementById('timeElapsed');
                this.smokeCondition = document.getElementById('smokeCondition');
                this.questionText = document.getElementById('questionText');
                this.choicesContainer = document.getElementById('choicesContainer');
                this.consequenceContainer = document.getElementById('consequenceContainer');
            }

            async initialize() {
                // Initialize with first question
                this.currentQuestion = 'initial_response';
                this.currentState = {
                    fire_location: 'Engine Room 2',
                    smoke_condition: 'light',
                    time_elapsed: 0,
                    compartments_affected: ['Engine Room 2'],
                    boundaries_set: false,
                    investigators_deployed: false,
                    fedfire_arrived: false
                };

                this.updateScenarioDisplay();
                this.displayQuestion();
            }

            updateScenarioDisplay() {
                this.scenarioDescription.textContent = 
                    `Fire reported in ${this.currentState.fire_location}. 
                     ${this.currentState.compartments_affected.length > 1 ? 
                       'Multiple compartments affected.' : 'Single compartment affected.'}`;
                this.fireLocation.textContent = this.currentState.fire_location;
                this.timeElapsed.textContent = `${Math.floor(this.currentState.time_elapsed)}:00`;
                this.smokeCondition.textContent = this.currentState.smoke_condition;
            }

            displayQuestion() {
                const question = {
                    text: "What is your initial response to the reported fire?",
                    choices: [
                        "A. Wait for FEDFIRE to arrive",
                        "B. Deploy investigators immediately",
                        "C. Evacuate the entire compartment",
                        "D. Set fire boundaries and deploy investigators"
                    ]
                };

                this.questionText.textContent = question.text;
                this.choicesContainer.innerHTML = question.choices
                    .map(choice => `
                        <div class="choice-option">
                            <input type="radio" name="response" value="${choice[0]}" id="choice${choice[0]}">
                            <label for="choice${choice[0]}">${choice}</label>
                        </div>
                    `).join('');

                // Add event listeners to choices
                this.choicesContainer.querySelectorAll('input[type="radio"]')
                    .forEach(input => {
                        input.addEventListener('change', (e) => this.handleChoice(e.target.value));
                    });
            }

            async handleChoice(choice) {
                try {
                    const response = await fetch('/api/dca-evaluate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            question_id: this.currentQuestion,
                            choice: choice,
                            current_state: this.currentState
                        })
                    });

                    const evaluation = await response.json();
                    this.showConsequences(evaluation);
                    // Don't call updateState since our API doesn't return new_state
                    // this.updateState(evaluation.new_state);
                } catch (error) {
                    console.error('Error evaluating choice:', error);
                    // Fallback to basic feedback if API fails
                    this.showConsequences({
                        score: 0.5,
                        feedback: "Unable to evaluate choice. Please try again.",
                        details: { time_score: 0.0 }
                    });
                }
            }

            showConsequences(evaluation) {
                // Handle the actual API response format
                const score = evaluation.score || 0;
                const feedback = evaluation.feedback || 'No feedback available';
                const isOptimal = score >= 0.8; // Consider scores >= 0.8 as optimal
                const timePenalty = evaluation.details?.time_score ? Math.round((1 - evaluation.details.time_score) * 5) : 5;
                
                const messageClass = isOptimal ? 'success' : 'warning';
                this.consequenceContainer.innerHTML = `
                    <div class="consequence-message ${messageClass}">
                        <p><strong>Time Impact:</strong> +${timePenalty} minutes</p>
                        <p>${feedback}</p>
                    </div>
                `;
            }

            updateState(newState) {
                this.currentState = newState;
                this.updateScenarioDisplay();
            }
        }

        // Initialize when the page loads
        window.addEventListener('load', () => {
            // Only initialize mode selection, not any assessment system
            showModeSelection();
        });
        
        // Function to show mode selection (main page)
        function showModeSelection() {
            document.getElementById('modeSelection').style.display = 'grid';
            document.getElementById('assessmentContent').classList.remove('active');
            document.getElementById('assessmentContent').innerHTML = ''; // Clear any stray content
            currentMode = null;
            
            // Reset assessment variables to prevent any stray initialization
            assessmentQuestions = [];
            currentQuestionIndex = 0;
            selectedAnswer = null;
            score = 0;
        }
    </script>
</body>
</html>
