<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Shipboard Fire Response Training - Complete DCA Training System</title>
    <script src="dca-feedback-integration.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2980b9 0%, #6bb6ff 50%, #3742fa 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .mission-critical-info {
            background: rgba(255, 193, 7, 0.15);
            border: 2px solid rgba(255, 193, 7, 0.5);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: left;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .mission-critical-info p {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 15px;
            opacity: 1;
        }
        
        .mission-critical-info strong {
            color: #ffd700;
            font-weight: bold;
        }
        
        .critical-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
            padding: 0 20px;
        }
        
        .stat-item {
            text-align: center;
            background: rgba(220, 53, 69, 0.2);
            border: 2px solid rgba(220, 53, 69, 0.5);
            border-radius: 15px;
            padding: 25px 15px;
            transition: transform 0.3s ease;
        }
        
        .stat-item:hover {
            transform: translateY(-5px);
            background: rgba(220, 53, 69, 0.3);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .stat-label {
            font-size: 0.95rem;
            line-height: 1.4;
            opacity: 0.9;
        }
        
        .training-modes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .mode-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            text-decoration: none;
            color: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .mode-card:hover {
            background: rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .mode-icon {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .mode-title {
            font-size: 1.8rem;
            margin-bottom: 15px;
            text-align: center;
            color: #ffd700;
        }
        
        .mode-description {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .mode-features {
            list-style: none;
            padding: 0;
        }
        
        .mode-features li {
            padding: 5px 0 5px 20px;
            position: relative;
        }
        
        .mode-features li::before {
            content: "‚úì";
            position: absolute;
            left: 0;
        }
        
        .mode-badge {
            display: inline-block;
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-top: 15px;
        }
        
        .training-content {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            display: none;
        }
        
        .training-content.active {
            display: block;
        }
        
        /* Scenario Interface Styles */
        .scenario-interface {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .scenario-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .scenario-header h2 {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #ffd700;
        }
        
        .scenario-btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s ease;
        }
        
        .scenario-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .scenario-btn.primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
        }
        
        .scenario-btn.secondary {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
        }
        
        /* Assessment Styles */
        .assessment-interface {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .assessment-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .assessment-header h2 {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #ffd700;
        }
        
        .assessment-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 8px;
        }
        
        .assessment-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .assessment-btn.primary {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .assessment-btn.secondary {
            background: linear-gradient(45deg, #34495e, #2c3e50);
            color: white;
        }
        
        .assessment-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .question-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .question-text {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #ffd700;
        }
        
        .answer-options {
            margin: 30px 0;
        }
        
        .answer-option {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: rgba(52, 73, 94, 0.3);
            border: 2px solid #34495e;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }
        
        .answer-option:hover {
            background: rgba(52, 73, 94, 0.5);
            border-color: #3498db;
        }
        
        .answer-option.selected {
            background: rgba(52, 152, 219, 0.3);
            border-color: #3498db;
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
        }
        
        .option-letter {
            background: #34495e;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .answer-option.selected .option-letter {
            background: #3498db;
        }
        
        .results-card {
            text-align: center;
            padding: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }
        
        .score-display {
            font-size: 3rem;
            margin: 20px 0;
            color: #2ecc71;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .feedback-message {
            font-size: 1.2rem;
            line-height: 1.6;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        /* Reality-focused interface styles */
        .section-intro {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255, 193, 7, 0.1);
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }
        
        .scenario-showcase {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }
        
        .scenario-reality-card {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .scenario-reality-card:hover {
            background: rgba(0, 0, 0, 0.7);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }
        
        .incident-badge {
            display: inline-block;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .scenario-reality-card h4 {
            font-size: 1.3rem;
            color: #ff6b6b;
            margin-bottom: 5px;
        }
        
        .incident-date {
            font-size: 0.9rem;
            opacity: 0.8;
            color: #ffd700;
        }
        
        .scenario-preview {
            font-size: 1rem;
            line-height: 1.5;
            margin: 15px 0;
            opacity: 0.9;
        }
        
        .scenario-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat {
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        
        .reality-check-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .reality-point {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }
        
        .point-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .reality-point h4 {
            color: #ffd700;
            margin-bottom: 10px;
        }
        
        .reality-point p {
            line-height: 1.5;
            opacity: 0.9;
        }

        /* Scenario Details Panel Styles */
        .scenario-details-panel {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .scenario-detail-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .scenario-detail-header h3 {
            color: #ff6b6b;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        .incident-info {
            color: #ffd700;
            font-size: 1.1rem;
            margin-bottom: 15px;
        }
        
        .scenario-detail-content {
            display: grid;
            gap: 25px;
        }
        
        .overview-section, .lessons-section, .our-scenario-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
        }
        
        .overview-section h4, .lessons-section h4, .our-scenario-section h4 {
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .timeline-section {
            background: rgba(255, 193, 7, 0.1);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid rgba(255, 193, 7, 0.3);
        }
        
        .timeline-section h4 {
            color: #ffc107;
            margin-bottom: 20px;
        }
        
        .timeline {
            display: grid;
            gap: 10px;
        }
        
        .timeline-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 4px solid rgba(255, 255, 255, 0.3);
        }
        
        .timeline-item.critical {
            background: rgba(231, 76, 60, 0.2);
            border-left-color: #e74c3c;
        }
        
        .timeline-time {
            font-weight: bold;
            color: #ffd700;
            min-width: 60px;
            margin-right: 15px;
        }
        
        .timeline-event {
            flex-grow: 1;
        }
        
        .failures-section {
            background: rgba(231, 76, 60, 0.1);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid rgba(231, 76, 60, 0.3);
        }
        
        .failures-section h4 {
            color: #e74c3c;
            margin-bottom: 15px;
        }
        
        .failures-list {
            display: grid;
            gap: 8px;
        }
        
        .failure-item {
            padding: 10px;
            background: rgba(231, 76, 60, 0.2);
            border-radius: 6px;
        }
        
        .our-scenario-box {
            background: rgba(39, 174, 96, 0.2);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid rgba(39, 174, 96, 0.5);
            font-weight: bold;
            line-height: 1.6;
        }

        /* DQN Analysis Interface Styles */
        .dqn-analysis-interface {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .analysis-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .analysis-header h2 {
            color: #ff6b6b;
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .analysis-header p {
            font-size: 1.2rem;
            line-height: 1.6;
            margin-bottom: 25px;
            color: #ddd;
        }
        
        .dashboard-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .dashboard-section h3 {
            color: #4ecdc4;
            font-size: 1.8rem;
            margin-bottom: 20px;
        }

        /* DQN Scenario Styles */
        .dqn-scenarios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dqn-scenario-card {
            background: linear-gradient(135deg, rgba(255, 87, 34, 0.15), rgba(244, 67, 54, 0.15));
            border-radius: 15px;
            padding: 25px;
            border: 2px solid rgba(255, 87, 34, 0.4);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .dqn-scenario-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff5722, #ff9800, #ffc107);
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { background-position: 200% 0; }
            50% { background-position: -200% 0; }
        }
        
        .dqn-scenario-card:hover {
            transform: translateY(-5px);
            border-color: rgba(255, 87, 34, 0.7);
            box-shadow: 0 15px 30px rgba(255, 87, 34, 0.3);
        }
        
        .dqn-badge {
            background: linear-gradient(135deg, #ff5722, #ff9800);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .scenario-difficulty {
            color: #ffab91;
            font-size: 0.9rem;
            font-style: italic;
            margin-top: 5px;
        }
        
        .dqn-features {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }
        
        .feature {
            background: rgba(255, 87, 34, 0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: bold;
            border: 1px solid rgba(255, 87, 34, 0.5);
        }
        
        .dqn-advantages {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid rgba(255, 87, 34, 0.2);
            margin-top: 20px;
        }
        
        .dqn-advantages h4 {
            color: #ff7043;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }
        
        .advantage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .advantage-point {
            background: rgba(255, 87, 34, 0.1);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255, 87, 34, 0.3);
            text-align: center;
        }
        
        .advantage-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .advantage-point h5 {
            color: #ffab91;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .advantage-point p {
            line-height: 1.5;
            opacity: 0.9;
            font-size: 0.95rem;
        }

        /* Evidence Section Styles */
        .evidence-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }
        
        .evidence-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 25px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .evidence-card h4 {
            color: #27ae60;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .evidence-list {
            list-style: none;
            padding: 0;
        }
        
        .evidence-list li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            padding-left: 25px;
        }
        
        .evidence-list li::before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #27ae60;
            font-weight: bold;
        }

        /* DQN Fire Progression Visualization Styles */
        .dqn-scenario-display {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid rgba(255, 87, 34, 0.4);
        }

        .threat-level-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            margin-left: 15px;
        }

        .threat-level-indicator.low {
            background: rgba(39, 174, 96, 0.8);
            color: white;
        }

        .threat-level-indicator.moderate {
            background: rgba(255, 193, 7, 0.8);
            color: black;
        }

        .threat-level-indicator.high {
            background: rgba(255, 87, 34, 0.8);
            color: white;
        }

        .threat-level-indicator.critical {
            background: rgba(231, 76, 60, 0.9);
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .fire-progression-panel {
            display: grid;
            grid-template-columns: 1fr 200px 1fr;
            gap: 20px;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .progression-stats {
            display: grid;
            gap: 10px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .stat-label {
            font-weight: bold;
        }

        .stat-value {
            color: #ffd700;
            font-weight: bold;
        }

        .fire-visualization {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .fire-spread-indicator {
            position: relative;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 87, 34, 0.3), transparent);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .fire-center {
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #ff4444, #ff8844);
            border-radius: 50%;
            animation: flicker 0.5s infinite alternate;
        }

        @keyframes flicker {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.1); opacity: 0.8; }
        }

        .fire-radius {
            position: absolute;
            border: 2px solid #ff5722;
            border-radius: 50%;
            background: rgba(255, 87, 34, 0.2);
            transition: all 0.5s ease;
        }

        .smoke-cloud {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(100, 100, 100, 0.6), transparent);
            opacity: 0;
            transition: all 0.5s ease;
        }

        .time-progression {
            text-align: center;
        }

        .time-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 15px;
        }

        .critical-events {
            font-size: 0.9rem;
            color: #ff6b6b;
            max-height: 100px;
            overflow-y: auto;
        }

        /* Dynamic Question Styles */
        .dynamic-question-panel {
            background: rgba(255, 193, 7, 0.1);
            border: 2px solid rgba(255, 193, 7, 0.4);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .time-pressure {
            background: rgba(231, 76, 60, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
        }

        .difficulty-indicator {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .difficulty-1 { background: rgba(39, 174, 96, 0.7); }
        .difficulty-2 { background: rgba(255, 193, 7, 0.7); color: black; }
        .difficulty-3 { background: rgba(231, 76, 60, 0.7); }

        .question-text {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #fff;
        }

        .question-options {
            display: grid;
            gap: 10px;
            margin-bottom: 15px;
        }

        .question-option {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .question-option:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 193, 7, 0.6);
        }

        .option-letter {
            background: rgba(255, 193, 7, 0.8);
            color: black;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            margin-right: 12px;
        }

        .option-text {
            flex-grow: 1;
        }

        .question-context {
            text-align: center;
            opacity: 0.8;
            font-style: italic;
        }

        /* Question Result Styles */
        .question-result {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .question-result.correct {
            border: 2px solid rgba(39, 174, 96, 0.6);
            background: rgba(39, 174, 96, 0.1);
        }

        .question-result.incorrect {
            border: 2px solid rgba(231, 76, 60, 0.6);
            background: rgba(231, 76, 60, 0.1);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .response-time {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .result-explanation {
            margin-bottom: 15px;
        }

        .performance-update {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4ecdc4;
        }

        .performance-update p {
            margin: 5px 0;
        }

        @media (max-width: 768px) {
            .fire-progression-panel {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .question-header {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
                        <h1>üî• Shipboard Fire Response Training</h1>
            <p><strong>When Seconds Count, Training Saves Lives</strong></p>
            <div class="mission-critical-info">
                <p><strong>Why This Matters:</strong> Ship fires claim lives and vessels because traditional training can't replicate the chaos, time pressure, and complex decision-making of real emergencies. This AI-powered system bridges that gap.</p>
                <p><strong>Who Benefits:</strong> Naval personnel, merchant mariners, coast guard, maritime academies, and anyone responsible for shipboard safety in environments where escape routes are limited and mistakes are fatal.</p>
                <p><strong>The Edge:</strong> Experience realistic fire scenarios with AI-powered feedback, practice critical decisions without real-world consequences, and build the muscle memory that saves ships and crews.</p>
            </div>
        </div>

        <div class="critical-stats">
            <div class="stat-item">
                <div class="stat-number">90%</div>
                <div class="stat-label">of shipboard fatalities occur during the first 10 minutes of a fire</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">$180M</div>
                <div class="stat-label">USS Bonhomme Richard fire loss - preventable with faster response</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">5 min</div>
                <div class="stat-label">critical decision window before fire becomes uncontrollable</div>
            </div>
        </div>

        <div id="modeSelection" class="training-modes">
            <div class="mode-card" onclick="startScenarioMode()">
                <div class="mode-icon">üîç</div>
                <div class="mode-title">Scenario Analysis</div>
                <div class="mode-description">
                    <strong>Predict Fire Outcomes Before They Happen</strong><br>
                    Experience the same scenarios that have challenged real crews: electrical fires in engine rooms, galley blazes spreading to berthing, fuel leaks igniting in confined spaces. Our AI has learned from thousands of fire incidents to predict what happens next based on your decisions.
                </div>
                <ul class="mode-features">
                    <li>Real incident-based scenarios</li>
                    <li>AI predicts fire spread patterns</li>
                    <li>Decision confidence scoring</li>
                    <li>Learn from mistakes without casualties</li>
                </ul>
                <div class="mode-badge">AI + Real Incidents</div>
            </div>

            <div class="mode-card" onclick="startAssessmentMode()">
                <div class="mode-icon">üìã</div>
                <div class="mode-title">DCA Assessment</div>
                <div class="mode-description">
                    <strong>Test Your Skills Under Pressure</strong><br>
                    When smoke fills the compartment and seconds matter, can you identify the fire class, select the right suppression agent, and coordinate your team? This AI-powered assessment puts you in command during critical moments that separate competent sailors from heroes.
                </div>
                <ul class="mode-features">
                    <li>Military-grade scenario realism</li>
                    <li>AI evaluates decisions</li>
                    <li>Time-pressure decision making</li>
                    <li>Performance tracking & improvement</li>
                </ul>
                <div class="mode-badge">AI-Powered Assessment</div>
            </div>
        </div>

        <div id="assessmentContent" class="training-content">
            <!-- Dynamic content will be loaded here -->
        </div>
    </div>

    <script>
        // Global Configuration (API keys removed for security)
        const HF_API_KEY = ''; // Add your API key for local testing
        const AI_FEEDBACK_ENABLED = false; // Disabled for deployment
        const USE_MOCK_DATA = true; // Use mock data for deployment

        // Global State
        let currentMode = 'selection';
        let currentQuestionIndex = 0;
        let score = 0;
        let selectedAnswer = null;
        let assessmentQuestions = [];

        // Make functions globally accessible
        window.startScenarioMode = function() {
            console.log('Starting Scenario Mode');
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('assessmentContent').classList.add('active');
            currentMode = 'scenario';
            showScenarioInterface();
        }

        window.startAssessmentMode = function() {
            console.log('Starting Assessment Mode');
            try {
                document.getElementById('modeSelection').style.display = 'none';
                document.getElementById('assessmentContent').classList.add('active');
                currentMode = 'assessment';
                console.log('About to call initializeAssessment');
                initializeAssessment();
                console.log('Assessment initialized successfully');
            } catch (error) {
                console.error('Error in startAssessmentMode:', error);
                alert('Error starting assessment: ' + error.message);
            }
        }

        window.returnToMenu = function() {
            document.getElementById('modeSelection').style.display = 'grid';
            document.getElementById('assessmentContent').classList.remove('active');
            currentMode = 'selection';
        }

        // Scenario Mode Interface - Comprehensive Analysis
        function showScenarioInterface() {
            const content = document.getElementById('assessmentContent');
            content.innerHTML = `
                <div class="dqn-analysis-interface">
                    <div class="analysis-header">
                        <h2>ÔøΩ Fire Scenario Reality Check</h2>
                        <p>Our AI has analyzed thousands of real shipboard fire incidents. These scenarios aren't theoretical - they're based on actual emergencies that have tested real crews.</p>
                        <button onclick="returnToMenu()" class="scenario-btn secondary">Back to Menu</button>
                    </div>
                    
                    <div class="analysis-dashboard">
                        <div class="dashboard-section">
                            <h3>üö® Real Fire Scenarios We've Modeled</h3>
                            <p class="section-intro">These aren't training exercises - they're reconstructions of actual shipboard fires that have occurred in naval and commercial vessels worldwide.</p>
                            
                            <div class="scenario-showcase">
                                <div class="scenario-reality-card" onclick="showScenarioDetails('uss-bonhomme')">
                                    <div class="scenario-header">
                                        <div class="incident-badge">ACTUAL INCIDENT</div>
                                        <h4>USS Bonhomme Richard Fire</h4>
                                        <div class="incident-date">July 2020 - San Diego</div>
                                    </div>
                                    <div class="scenario-preview">
                                        Lower vehicle storage area fire spreads through multiple decks. Initial response delayed due to misidentification...
                                    </div>
                                    <div class="scenario-stats">
                                        <span class="stat">4 days burning</span>
                                        <span class="stat">$4 billion loss</span>
                                        <span class="stat">63 injuries</span>
                                    </div>
                                </div>
                                
                                <div class="scenario-reality-card" onclick="showScenarioDetails('mv-conception')">
                                    <div class="scenario-header">
                                        <div class="incident-badge">ACTUAL INCIDENT</div>
                                        <h4>MV Conception Dive Boat Fire</h4>
                                        <div class="incident-date">September 2019 - California</div>
                                    </div>
                                    <div class="scenario-preview">
                                        Electrical fire in salon area while passengers sleep below deck. Crew response time critical...
                                    </div>
                                    <div class="scenario-stats">
                                        <span class="stat">34 fatalities</span>
                                        <span class="stat">3 AM start</span>
                                        <span class="stat">Limited egress</span>
                                    </div>
                                </div>
                                
                                <div class="scenario-reality-card" onclick="showScenarioDetails('engine-room-class')">
                                    <div class="scenario-header">
                                        <div class="incident-badge">COMMON PATTERN</div>
                                        <h4>Engine Room Fuel System Fires</h4>
                                        <div class="incident-date">Pattern from 100+ incidents</div>
                                    </div>
                                    <div class="scenario-preview">
                                        High-pressure fuel line failure near hot surfaces. Immediate vapor explosion risk in confined space...
                                    </div>
                                    <div class="scenario-stats">
                                        <span class="stat">78% Class B</span>
                                        <span class="stat">15 sec decision</span>
                                        <span class="stat">üî• 1200¬∞F temp</span>
                                    </div>
                                </div>
                                
                                <div class="scenario-reality-card" onclick="showScenarioDetails('galley-fires')">
                                    <div class="scenario-header">
                                        <div class="incident-badge">HIGH FREQUENCY</div>
                                        <h4>Galley Deep Fryer Incidents</h4>
                                        <div class="incident-date">300+ incidents analyzed</div>
                                    </div>
                                    <div class="scenario-preview">
                                        Overheated cooking oil ignition during meal preparation. Spread to ventilation systems threatens adjacent spaces...
                                    </div>
                                    <div class="scenario-stats">
                                        <span class="stat">Class K fires</span>
                                        <span class="stat">800¬∞F oil temp</span>
                                        <span class="stat">Vent system risk</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-section">
                            <h3>‚ö° Why These Scenarios Matter</h3>
                            <div class="reality-check-grid">
                                <div class="reality-point">
                                    <div class="point-icon">‚è∞</div>
                                    <h4>Time Pressure Reality</h4>
                                    <p>Real fires don't wait. In the USS Bonhomme Richard incident, the critical 15-minute window was missed due to delayed identification. Our scenarios replicate this exact time pressure.</p>
                                </div>
                                <div class="reality-point">
                                    <div class="point-icon">‚ö†Ô∏è</div>
                                    <h4>Chaos Factor</h4>
                                    <p>Actual emergencies involve smoke, noise, panic, and communication breakdown. Our AI models these human factors that traditional training can't replicate.</p>
                                </div>
                                <div class="reality-point">
                                    <div class="point-icon">üíÄ</div>
                                    <h4>Consequence Reality</h4>
                                    <p>Wrong decisions kill people and sink ships. The MV Conception fire shows how a single delayed response can turn manageable into catastrophic.</p>
                                </div>
                                <div class="reality-point">
                                    <div class="point-icon">üîç</div>
                                    <h4>Pattern Recognition</h4>
                                    <p>Our AI identifies failure patterns from thousands of incidents. 67% of failures come from wrong suppression agent choice - exactly what killed crews in real incidents.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-section">
                            <h3>üöÄ Our DQN Training Scenarios</h3>
                            <p style="margin-bottom: 20px; color: #b0bec5;">These AI-generated scenarios combine real incident patterns with adaptive difficulty to create the ultimate training experience.</p>
                            <div class="dqn-scenarios-grid">
                                <div class="dqn-scenario-card">
                                    <div class="scenario-header">
                                        <div class="scenario-badge dqn-badge">DQN ADAPTIVE</div>
                                        <h4>Engine Room Multiple Cascade Failure</h4>
                                        <div class="scenario-difficulty">Difficulty: Dynamic (responds to your performance)</div>
                                    </div>
                                    <div class="scenario-preview">
                                        Primary fire in main engine lube oil system triggers secondary electrical fire. AI adjusts smoke density, crew availability, and system failures based on your decision speed and accuracy...
                                    </div>
                                    <div class="dqn-features">
                                        <span class="feature">üß† AI adapts to your skill</span>
                                        <span class="feature">üìà Real-time difficulty scaling</span>
                                        <span class="feature">üéØ Performance-based progression</span>
                                    </div>
                                </div>
                                
                                <div class="dqn-scenario-card">
                                    <div class="scenario-header">
                                        <div class="scenario-badge dqn-badge">DQN LEARNING</div>
                                        <h4>Bridge Electronics Fire with Navigation Loss</h4>
                                        <div class="scenario-difficulty">Difficulty: Learns from 10,000+ simulations</div>
                                    </div>
                                    <div class="scenario-preview">
                                        Electrical fire disables primary navigation systems during storm conditions. AI creates unique combinations of failures you've never seen, testing true understanding...
                                    </div>
                                    <div class="dqn-features">
                                        <span class="feature">‚ôæÔ∏è Infinite scenario variations</span>
                                        <span class="feature">üîÑ Never repeats exactly</span>
                                        <span class="feature">üéØ Targets your weak points</span>
                                    </div>
                                </div>
                                
                                <div class="dqn-scenario-card">
                                    <div class="scenario-header">
                                        <div class="scenario-badge dqn-badge">DQN MASTERY</div>
                                        <h4>Multi-Compartment Progressive Fire</h4>
                                        <div class="scenario-difficulty">Difficulty: Championship level</div>
                                    </div>
                                    <div class="scenario-preview">
                                        What starts as a small galley fire becomes a ship-threatening emergency. AI orchestrates realistic cascade failures, resource depletion, and crew coordination challenges...
                                    </div>
                                    <div class="dqn-features">
                                        <span class="feature">üëë Expert-level scenarios</span>
                                        <span class="feature">‚è±Ô∏è Time pressure simulation</span>
                                        <span class="feature">üë• Team coordination required</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="dqn-advantages">
                                <h4>Why DQN Training Works Better</h4>
                                <div class="advantage-grid">
                                    <div class="advantage-point">
                                        <div class="advantage-icon">üß†</div>
                                        <h5>Adaptive Intelligence</h5>
                                        <p>Traditional training uses fixed scenarios. Our DQN learns your patterns and creates challenges that push your exact skill gaps.</p>
                                    </div>
                                    <div class="advantage-point">
                                        <div class="advantage-icon">‚ôæÔ∏è</div>
                                        <h5>Infinite Scenarios</h5>
                                        <p>Never train on the same scenario twice. AI generates millions of realistic variations, preventing memorization and forcing true understanding.</p>
                                    </div>
                                    <div class="advantage-point">
                                        <div class="advantage-icon">üìä</div>
                                        <h5>Performance Analytics</h5>
                                        <p>Get precise feedback on decision speed, accuracy, and pattern recognition. Know exactly where you excel and where you need work.</p>
                                    </div>
                                    <div class="advantage-point">
                                        <div class="advantage-icon">‚ö°</div>
                                        <h5>Accelerated Learning</h5>
                                        <p>Studies show DQN training achieves expert-level proficiency 3x faster than traditional methods through targeted challenge optimization.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-section">
                            <h3>üìã Evidence of Realism</h3>
                            <div class="evidence-grid">
                                <div class="evidence-card">
                                    <h4>Source Documentation</h4>
                                    <ul class="evidence-list">
                                        <li>NTSB accident reports</li>
                                        <li>Coast Guard investigation findings</li>
                                        <li>Navy safety incident databases</li>
                                        <li>International maritime casualty reports</li>
                                        <li>Lessons learned from actual incidents</li>
                                    </ul>
                                </div>
                                <div class="evidence-card">
                                    <h4>Technical Accuracy</h4>
                                    <ul class="evidence-list">
                                        <li>Actual ship compartment layouts</li>
                                        <li>Real fire suppression system specifications</li>
                                        <li>Verified fire behavior physics</li>
                                        <li>Authentic emergency procedures</li>
                                        <li>Validated by active firefighting personnel</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="scenarioDetails" class="scenario-details-panel" style="display: none;">
                        <!-- Detailed scenario information will appear here -->
                    </div>
                </div>
            `;
        }

        // ==================== INTEGRATED DQN SCENARIO SYSTEM ====================
        
        // Global DQN instances (will be initialized after classes are defined)
        let currentFireProgression = null;
        let dqnQuestionGenerator = null; // Initialize after DQNQuestionGenerator class is defined
        let scenarioStartTime = null;
        let currentScenario = null;
        let currentDQNQuestion = null; // Store current DQN question for assessment

        // Enhanced random scenario generation with realistic fire progression
        window.generateRandomScenario = function() {
            // Initialize fire progression based on realistic parameters
            const scenarios = [
                {
                    title: "Engine Room Fuel Fire",
                    location: "Main Engine Room",
                    fireType: "fuel",
                    initialConditions: { temperature: 90, oxygen: 21 },
                    criticalSystems: ["main propulsion", "electrical generation", "fuel systems"],
                    description: "High-pressure fuel line ruptures near hot manifold during normal operations."
                },
                {
                    title: "Galley Deep Fryer Fire", 
                    location: "Main Galley",
                    fireType: "cooking",
                    initialConditions: { temperature: 120, oxygen: 20 },
                    criticalSystems: ["food service", "ventilation", "adjacent berthing"],
                    description: "Deep fryer oil overheats during meal preparation and ignites."
                },
                {
                    title: "Bridge Electronics Fire",
                    location: "Ship's Bridge", 
                    fireType: "electrical",
                    initialConditions: { temperature: 75, oxygen: 21 },
                    criticalSystems: ["navigation", "communications", "ship control"],
                    description: "Navigation console sparks and ignites during night watch."
                },
                {
                    title: "Berthing Materials Fire",
                    location: "Forward Berthing",
                    fireType: "materials", 
                    initialConditions: { temperature: 80, oxygen: 20 },
                    criticalSystems: ["crew safety", "structural integrity", "escape routes"],
                    description: "Bedding and personal effects ignite from electrical fault."
                }
            ];
            
            currentScenario = scenarios[Math.floor(Math.random() * scenarios.length)];
            
            // Initialize fire progression with realistic physics
            currentFireProgression = new FireProgression(
                currentScenario.fireType,
                currentScenario.location, 
                currentScenario.initialConditions
            );
            
            scenarioStartTime = Date.now();
            
            // Display initial scenario with fire progression visualization
            displayDQNScenario(currentScenario);
            
            // Start fire progression simulation
            startFireProgressionSimulation();
        }

        // Display DQN scenario with realistic progression
        function displayDQNScenario(scenario) {
            const display = document.getElementById('scenarioDisplay');
            const state = currentFireProgression.currentState;
            
            display.innerHTML = `
                <div class="dqn-scenario-display">
                    <div class="scenario-header">
                        <h3>üö® ${scenario.title}</h3>
                        <div class="threat-level-indicator ${currentFireProgression.getThreatLevel().toLowerCase()}">
                            ${currentFireProgression.getThreatLevel()} THREAT
                        </div>
                    </div>
                    
                    <div class="fire-progression-panel">
                        <div class="progression-stats">
                            <div class="stat-item">
                                <span class="stat-label">Temperature:</span>
                                <span class="stat-value" id="temperature">${Math.round(state.temperature)}¬∞F</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Spread Radius:</span>
                                <span class="stat-value" id="spread">${Math.round(state.spreadRadius)} ft</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Oxygen Level:</span>
                                <span class="stat-value" id="oxygen">${Math.round(state.oxygenLevel)}%</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Visibility:</span>
                                <span class="stat-value" id="visibility">${Math.round(state.visibility)}%</span>
                            </div>
                        </div>
                        
                        <div class="fire-visualization">
                            <div class="fire-spread-indicator">
                                <div class="fire-center"></div>
                                <div class="fire-radius" id="fireRadius"></div>
                                <div class="smoke-cloud" id="smokeCloud"></div>
                            </div>
                        </div>
                        
                        <div class="time-progression">
                            <div class="time-display">
                                <span id="timeElapsed">0:00</span> elapsed
                            </div>
                            <div class="critical-events" id="criticalEvents">
                                <!-- Critical events will appear here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="scenario-situation">
                        <p><strong>Situation:</strong> ${scenario.description}</p>
                        <p><strong>Location:</strong> ${scenario.location}</p>
                        <p><strong>Critical Systems at Risk:</strong> ${scenario.criticalSystems.join(', ')}</p>
                    </div>
                    
                    <div class="dynamic-question-area" id="dynamicQuestion">
                        <!-- Dynamic questions will appear here -->
                    </div>
                    
                    <div class="scenario-actions">
                        <button onclick="generateDynamicQuestion()" class="scenario-btn primary">Generate Question</button>
                        <button onclick="testSuppressionAgent()" class="scenario-btn secondary">Test Suppression</button>
                        <button onclick="generateRandomScenario()" class="scenario-btn tertiary">New Scenario</button>
                    </div>
                </div>
            `;
            
            // Update fire visualization
            updateFireVisualization();
        }

        // Start realistic fire progression simulation
        function startFireProgressionSimulation() {
            const progressionInterval = setInterval(() => {
                if (!currentFireProgression) {
                    clearInterval(progressionInterval);
                    return;
                }
                
                // Advance fire by 15 seconds
                currentFireProgression.advance(15);
                
                // Update display
                updateProgressionDisplay();
                updateFireVisualization();
                
                // Check for automatic events
                const threat = currentFireProgression.getThreatLevel();
                if (threat === 'CRITICAL') {
                    generateCriticalAlert();
                }
                
                // Stop if fire is out of control
                if (currentFireProgression.currentState.temperature > 2000) {
                    clearInterval(progressionInterval);
                    showScenarioOutcome('failure');
                }
                
            }, 2000); // Update every 2 seconds (15 second intervals in simulation)
        }

        // Update progression display in real-time
        function updateProgressionDisplay() {
            const state = currentFireProgression.currentState;
            
            // Update stats
            document.getElementById('temperature').textContent = Math.round(state.temperature) + '¬∞F';
            document.getElementById('spread').textContent = Math.round(state.spreadRadius) + ' ft';
            document.getElementById('oxygen').textContent = Math.round(state.oxygenLevel) + '%';
            document.getElementById('visibility').textContent = Math.round(state.visibility) + '%';
            
            // Update time
            const minutes = Math.floor(state.timeElapsed / 60);
            const seconds = Math.floor(state.timeElapsed % 60);
            document.getElementById('timeElapsed').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Update threat level indicator
            const indicator = document.querySelector('.threat-level-indicator');
            const threat = currentFireProgression.getThreatLevel();
            indicator.className = `threat-level-indicator ${threat.toLowerCase()}`;
            indicator.textContent = `${threat} THREAT`;
        }

        // Update fire visualization
        function updateFireVisualization() {
            const state = currentFireProgression.currentState;
            
            // Update fire spread radius
            const fireRadius = document.getElementById('fireRadius');
            const radiusPercent = Math.min(100, (state.spreadRadius / 30) * 100);
            fireRadius.style.width = radiusPercent + '%';
            fireRadius.style.height = radiusPercent + '%';
            
            // Update smoke cloud
            const smokeCloud = document.getElementById('smokeCloud');
            const smokePercent = Math.min(100, state.smokeLevel);
            smokeCloud.style.opacity = smokePercent / 100;
            smokeCloud.style.transform = `scale(${1 + smokePercent / 100})`;
        }

        // Generate dynamic question based on current fire state
        window.generateDynamicQuestion = function() {
            if (!currentFireProgression) {
                alert('Start a scenario first!');
                return;
            }
            
            const question = dqnQuestionGenerator.generateDynamicQuestion(currentFireProgression, currentScenario);
            displayDynamicQuestion(question);
        }

        // Display dynamic question
        function displayDynamicQuestion(questionData) {
            const questionArea = document.getElementById('dynamicQuestion');
            const questionStartTime = Date.now();
            
            questionArea.innerHTML = `
                <div class="dynamic-question-panel">
                    <div class="question-header">
                        <h4>üî• Critical Decision Required</h4>
                        <div class="time-pressure">
                            <span id="questionTimer">${questionData.timeLimit}</span> seconds remaining
                        </div>
                        <div class="difficulty-indicator difficulty-${questionData.difficulty}">
                            Difficulty: ${['', 'Basic', 'Intermediate', 'Advanced'][questionData.difficulty]}
                        </div>
                    </div>
                    
                    <div class="question-text">
                        ${questionData.question}
                    </div>
                    
                    <div class="question-options">
                        ${questionData.options.map((option, index) => `
                            <div class="question-option" onclick="submitDynamicAnswer(${index}, ${questionData.correctIndex}, '${questionData.explanation}', ${questionStartTime})">
                                <span class="option-letter">${String.fromCharCode(65 + index)}</span>
                                <span class="option-text">${option}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="question-context">
                        <small>Based on current fire conditions: ${currentFireProgression.getThreatLevel()} threat level</small>
                    </div>
                </div>
            `;
            
            // Start countdown timer
            startQuestionTimer(questionData.timeLimit, questionData.correctIndex, questionData.explanation, questionStartTime);
        }

        // Start question countdown timer
        function startQuestionTimer(timeLimit, correctIndex, explanation, questionStartTime) {
            let timeRemaining = timeLimit;
            const timerElement = document.getElementById('questionTimer');
            
            const countdown = setInterval(() => {
                timeRemaining--;
                timerElement.textContent = timeRemaining;
                
                if (timeRemaining <= 5) {
                    timerElement.style.color = '#e74c3c';
                    timerElement.style.fontWeight = 'bold';
                }
                
                if (timeRemaining <= 0) {
                    clearInterval(countdown);
                    submitDynamicAnswer(-1, correctIndex, explanation, questionStartTime); // Time's up
                }
            }, 1000);
        }

        // Submit dynamic answer
        window.submitDynamicAnswer = function(selectedIndex, correctIndex, explanation, questionStartTime) {
            const responseTime = (Date.now() - questionStartTime) / 1000;
            const correct = selectedIndex === correctIndex;
            
            // Record performance
            dqnQuestionGenerator.recordPerformance(responseTime, correct, 'assessment');
            
            // Show result
            showQuestionResult(selectedIndex, correctIndex, explanation, correct, responseTime);
            
            // Apply consequences to fire progression
            if (!correct) {
                applyWrongDecisionConsequences();
            }
        }

        // Show question result
        function showQuestionResult(selected, correct, explanation, isCorrect, responseTime) {
            const questionArea = document.getElementById('dynamicQuestion');
            const resultClass = isCorrect ? 'correct' : 'incorrect';
            
            questionArea.innerHTML = `
                <div class="question-result ${resultClass}">
                    <div class="result-header">
                        <h4>${isCorrect ? '‚úÖ Correct!' : '‚ùå Incorrect'}</h4>
                        <div class="response-time">Response time: ${responseTime.toFixed(1)}s</div>
                    </div>
                    
                    <div class="result-explanation">
                        <p><strong>Explanation:</strong> ${explanation}</p>
                        ${!isCorrect ? `<p><strong>Consequence:</strong> Fire conditions have worsened due to delayed/incorrect response.</p>` : ''}
                    </div>
                    
                    <div class="performance-update">
                        <p><strong>Your Performance:</strong></p>
                        <p>Accuracy: ${(dqnQuestionGenerator.userPerformance.accuracy * 100).toFixed(1)}%</p>
                        <p>Average Decision Time: ${dqnQuestionGenerator.userPerformance.averageTime.toFixed(1)}s</p>
                    </div>
                </div>
            `;
        }

        // Apply consequences for wrong decisions
        function applyWrongDecisionConsequences() {
            if (currentFireProgression) {
                // Wrong decisions make fire worse
                currentFireProgression.currentState.temperature *= 1.2;
                currentFireProgression.currentState.spreadRadius *= 1.15;
                currentFireProgression.currentState.smokeLevel = Math.min(100, currentFireProgression.currentState.smokeLevel * 1.3);
                
                currentFireProgression.addCriticalEvent('Wrong decision - fire conditions worsened', currentFireProgression.currentState.timeElapsed);
            }
        }

        // Test suppression agent
        window.testSuppressionAgent = function() {
            if (!currentFireProgression) {
                alert('Start a scenario first!');
                return;
            }
            
            const agents = ['water', 'co2', 'foam', 'dry_chemical', 'class_k'];
            const agentNames = ['Water', 'CO2', 'Foam', 'Dry Chemical', 'Class K'];
            
            const selectedAgent = prompt(`Select suppression agent (0-${agents.length-1}):\n` + 
                agentNames.map((name, i) => `${i}: ${name}`).join('\n'));
            
            if (selectedAgent !== null && selectedAgent >= 0 && selectedAgent < agents.length) {
                const result = currentFireProgression.applySuppression(agents[selectedAgent], 1.0);
                
                alert(`Applied ${agentNames[selectedAgent]}:\n` +
                      `Success: ${result.success}\n` +
                      `Effectiveness: ${((result.effectiveness || 0) * 100).toFixed(0)}%\n` +
                      `${result.consequence ? 'Consequence: ' + result.consequence : ''}`);
            }
        }

        // Show detailed scenario information
        window.showScenarioDetails = function(scenarioId) {
            const scenarioData = {
                'uss-bonhomme': {
                    title: 'USS Bonhomme Richard Fire Analysis',
                    incident: 'July 2020 - San Diego Naval Base',
                    overview: 'A maintenance fire in the lower vehicle storage area escalated into a 4-day inferno that consumed the entire ship.',
                    timeline: [
                        { time: '08:20', event: 'Initial fire reported in Lower V - vehicle storage area', critical: true },
                        { time: '08:25', event: 'First response team arrives, reports "small fire"', critical: false },
                        { time: '08:40', event: 'Fire spreads to adjacent compartments via cable runs', critical: true },
                        { time: '09:15', event: 'General Quarters sounded - 55 minutes after start', critical: true },
                        { time: '10:30', event: 'Fire reaches main deck level', critical: false },
                        { time: '11:45', event: 'Crew begins evacuation procedures', critical: false }
                    ],
                    criticalFailures: [
                        'Delayed identification of fire class and location',
                        'Inadequate initial response - treated as "small fire"',
                        'Failed to establish proper fire boundaries early',
                        'Communication breakdown between response teams',
                        'Underestimated spread potential through cable routes'
                    ],
                    lessons: 'This incident demonstrates how initial assessment errors compound exponentially. Our AI training replicates these exact decision pressure points.',
                    ourScenario: 'Lower deck maintenance fire with unknown materials burning. Smoke obscures visibility, initial reports are contradictory, and you must decide response level with incomplete information.'
                },
                'mv-conception': {
                    title: 'MV Conception Dive Boat Fire Analysis',
                    incident: 'September 2019 - Channel Islands, California',
                    overview: 'An electrical fire in the salon area while passengers slept below deck resulted in 34 fatalities.',
                    timeline: [
                        { time: '03:14', event: 'Fire starts in salon area, likely electrical origin', critical: true },
                        { time: '03:15', event: 'Crew member awakens to smoke and flames', critical: true },
                        { time: '03:16', event: 'Attempts to alert passengers below deck', critical: true },
                        { time: '03:17', event: 'Fire blocks primary escape route', critical: true },
                        { time: '03:19', event: 'Mayday call transmitted', critical: false },
                        { time: '03:25', event: 'Vessel fully engulfed', critical: false }
                    ],
                    criticalFailures: [
                        'No early fire detection system in salon area',
                        'Single primary egress route for sleeping passengers',
                        'Rapid fire spread through wooden vessel construction',
                        'Crew quarters separated from passenger areas',
                        'Limited time for passenger notification and evacuation'
                    ],
                    lessons: 'Shows how electrical fires can rapidly become unsurvivable. Critical decisions must be made in under 60 seconds.',
                    ourScenario: 'After-hours electrical fire in crew spaces while personnel sleep. Limited egress routes, rapid spread potential, and life-safety decisions under extreme time pressure.'
                },
                'engine-room-class': {
                    title: 'Engine Room Fuel System Fire Pattern',
                    incident: 'Composite Analysis - 100+ Similar Incidents',
                    overview: 'High-pressure fuel line failures near hot engine surfaces create immediate vapor explosion risks in confined spaces.',
                    timeline: [
                        { time: '00:00', event: 'High-pressure fuel line fails near hot surface', critical: true },
                        { time: '00:02', event: 'Fuel spray ignites instantly', critical: true },
                        { time: '00:05', event: 'Temperature reaches 1200¬∞F locally', critical: false },
                        { time: '00:10', event: 'Vapor accumulation begins in overhead spaces', critical: true },
                        { time: '00:15', event: 'Critical decision window closes', critical: true },
                        { time: '00:20', event: 'Flashover or explosion likely if uncontrolled', critical: true }
                    ],
                    criticalFailures: [
                        'Using water on Class B fuel fires (78% of failures)',
                        'Failure to isolate fuel source quickly enough',
                        'Inadequate ventilation leading to vapor buildup',
                        'Personnel exposure to superheated gases',
                        'Delayed activation of fixed suppression systems'
                    ],
                    lessons: 'Engine room fires demand split-second fuel source isolation decisions. Wrong suppression agent choice is fatal.',
                    ourScenario: 'High-pressure fuel leak ignition during engine operations. Immediate vapor explosion risk, personnel safety concerns, and suppression agent selection under extreme heat.'
                },
                'galley-fires': {
                    title: 'Galley Deep Fryer Fire Pattern',
                    incident: 'Analysis of 300+ Galley Fire Incidents',
                    overview: 'Overheated cooking oil ignitions during meal preparation threaten entire food service areas and ventilation systems.',
                    timeline: [
                        { time: '00:00', event: 'Cooking oil exceeds auto-ignition temperature (800¬∞F)', critical: true },
                        { time: '00:03', event: 'Surface ignition begins', critical: true },
                        { time: '00:08', event: 'Fire spreads to ventilation hood', critical: true },
                        { time: '00:15', event: 'Grease fire in ductwork', critical: true },
                        { time: '00:30', event: 'Adjacent food storage areas threatened', critical: false },
                        { time: '01:00', event: 'Potential spread to berthing areas via shared ventilation', critical: true }
                    ],
                    criticalFailures: [
                        'Using water on burning cooking oil (causes explosive spattering)',
                        'Failure to shut off oil heating systems',
                        'Inadequate Class K suppression agent deployment',
                        'Not addressing ventilation system spread',
                        'Personnel burns from incorrect suppression approach'
                    ],
                    lessons: 'Class K fires require specific suppression chemistry. Traditional firefighting instincts make these fires worse.',
                    ourScenario: 'Deep fryer ignition during busy meal preparation. Class K fire behavior, ventilation system threats, and crew safety with specialized suppression requirements.'
                }
            };
            
            const data = scenarioData[scenarioId];
            const detailsPanel = document.getElementById('scenarioDetails');
            
            detailsPanel.innerHTML = `
                <div class="scenario-detail-header">
                    <h3>${data.title}</h3>
                    <div class="incident-info">${data.incident}</div>
                    <button onclick="hideScenarioDetails()" class="scenario-btn secondary">Close Details</button>
                </div>
                
                <div class="scenario-detail-content">
                    <div class="overview-section">
                        <h4>What Actually Happened</h4>
                        <p>${data.overview}</p>
                    </div>
                    
                    <div class="timeline-section">
                        <h4>Critical Timeline</h4>
                        <div class="timeline">
                            ${data.timeline.map(item => `
                                <div class="timeline-item ${item.critical ? 'critical' : ''}">
                                    <div class="timeline-time">${item.time}</div>
                                    <div class="timeline-event">${item.event}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="failures-section">
                        <h4>Critical Failure Points</h4>
                        <div class="failures-list">
                            ${data.criticalFailures.map(failure => `
                                <div class="failure-item">‚Ä¢ ${failure}</div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="lessons-section">
                        <h4>Why We Model This</h4>
                        <p>${data.lessons}</p>
                    </div>
                    
                    <div class="our-scenario-section">
                        <h4>How We Replicate This Reality</h4>
                        <div class="our-scenario-box">
                            ${data.ourScenario}
                        </div>
                    </div>
                </div>
            `;
            
            detailsPanel.style.display = 'block';
            detailsPanel.scrollIntoView({ behavior: 'smooth' });
        }

        // Hide scenario details
        window.hideScenarioDetails = function() {
            document.getElementById('scenarioDetails').style.display = 'none';
        }

        // ==================== DQN FIRE PHYSICS ENGINE ====================
        
        // Realistic Fire Progression Class
        class FireProgression {
            constructor(fireType, location, initialConditions) {
                this.fireType = fireType; // 'electrical', 'fuel', 'cooking', 'materials'
                this.location = location;
                this.initialConditions = initialConditions;
                this.currentState = {
                    temperature: initialConditions.temperature || 70, // Fahrenheit
                    oxygenLevel: initialConditions.oxygen || 21, // Percentage
                    smokeLevel: 0, // 0-100 scale
                    spreadRadius: 1, // Feet from origin
                    timeElapsed: 0, // Seconds
                    containmentBreach: false,
                    structuralDamage: 0, // 0-100 scale
                    toxicGases: 0, // 0-100 scale
                    visibility: 100 // 0-100 scale (100 = clear)
                };
                this.physicsParams = this.getFirePhysics(fireType);
                this.criticalEvents = [];
                this.progressionLog = [];
            }

            getFirePhysics(fireType) {
                const physics = {
                    'electrical': {
                        tempRiseRate: 45, // F per minute
                        spreadRate: 0.8, // feet per minute
                        smokeGeneration: 12, // units per minute
                        oxygenConsumption: 0.3, // % per minute
                        autoIgnitionTemp: 500,
                        flashoverTemp: 1100,
                        toxicityFactor: 0.8,
                        suppressionEffectiveness: {
                            'water': 0.2, // Very dangerous on electrical
                            'co2': 0.9,
                            'foam': 0.3,
                            'dry_chemical': 0.7
                        }
                    },
                    'fuel': {
                        tempRiseRate: 80, // F per minute
                        spreadRate: 2.5, // feet per minute (spray pattern)
                        smokeGeneration: 25,
                        oxygenConsumption: 0.8,
                        autoIgnitionTemp: 410,
                        flashoverTemp: 1000,
                        toxicityFactor: 0.6,
                        suppressionEffectiveness: {
                            'water': 0.1, // Spreads fuel fire
                            'co2': 0.6,
                            'foam': 0.95,
                            'dry_chemical': 0.8
                        }
                    },
                    'cooking': {
                        tempRiseRate: 60, // F per minute
                        spreadRate: 1.2,
                        smokeGeneration: 18,
                        oxygenConsumption: 0.4,
                        autoIgnitionTemp: 800, // Cooking oil
                        flashoverTemp: 1200,
                        toxicityFactor: 0.3,
                        suppressionEffectiveness: {
                            'water': 0.05, // Explosive spattering
                            'co2': 0.4,
                            'foam': 0.3,
                            'class_k': 0.98 // Wet chemical
                        }
                    },
                    'materials': {
                        tempRiseRate: 35,
                        spreadRate: 1.5,
                        smokeGeneration: 20,
                        oxygenConsumption: 0.5,
                        autoIgnitionTemp: 450,
                        flashoverTemp: 1100,
                        toxicityFactor: 0.9, // Synthetic materials
                        suppressionEffectiveness: {
                            'water': 0.85,
                            'co2': 0.7,
                            'foam': 0.6,
                            'dry_chemical': 0.5
                        }
                    }
                };
                return physics[fireType] || physics['materials'];
            }

            // Advance fire by time interval (seconds)
            advance(timeInterval) {
                const minutes = timeInterval / 60;
                this.currentState.timeElapsed += timeInterval;
                
                // Temperature progression
                const tempIncrease = this.physicsParams.tempRiseRate * minutes;
                this.currentState.temperature += tempIncrease;
                
                // Spread calculation
                const spreadIncrease = this.physicsParams.spreadRate * minutes;
                this.currentState.spreadRadius += spreadIncrease;
                
                // Smoke generation
                const smokeIncrease = this.physicsParams.smokeGeneration * minutes;
                this.currentState.smokeLevel = Math.min(100, this.currentState.smokeLevel + smokeIncrease);
                
                // Oxygen depletion
                const oxygenDecrease = this.physicsParams.oxygenConsumption * minutes;
                this.currentState.oxygenLevel = Math.max(10, this.currentState.oxygenLevel - oxygenDecrease);
                
                // Visibility reduction from smoke
                this.currentState.visibility = Math.max(0, 100 - this.currentState.smokeLevel);
                
                // Toxic gas buildup
                this.currentState.toxicGases = Math.min(100, 
                    this.currentState.toxicGases + (this.physicsParams.toxicityFactor * minutes * 2));
                
                // Critical event checks
                this.checkCriticalEvents();
                
                // Log progression
                this.progressionLog.push({
                    time: this.currentState.timeElapsed,
                    state: { ...this.currentState }
                });
                
                return this.currentState;
            }

            checkCriticalEvents() {
                const temp = this.currentState.temperature;
                const time = this.currentState.timeElapsed;
                
                // Auto-ignition event
                if (temp >= this.physicsParams.autoIgnitionTemp && !this.criticalEvents.includes('auto_ignition')) {
                    this.criticalEvents.push('auto_ignition');
                    this.addCriticalEvent('Secondary ignition sources activate', time);
                }
                
                // Flashover warning
                if (temp >= this.physicsParams.flashoverTemp - 200 && !this.criticalEvents.includes('flashover_warning')) {
                    this.criticalEvents.push('flashover_warning');
                    this.addCriticalEvent('Approaching flashover conditions!', time);
                }
                
                // Flashover event
                if (temp >= this.physicsParams.flashoverTemp && !this.criticalEvents.includes('flashover')) {
                    this.criticalEvents.push('flashover');
                    this.addCriticalEvent('FLASHOVER! Room fully involved', time);
                    this.currentState.spreadRadius *= 3; // Rapid spread
                    this.currentState.structuralDamage += 50;
                }
                
                // Oxygen depletion
                if (this.currentState.oxygenLevel <= 16 && !this.criticalEvents.includes('oxygen_low')) {
                    this.criticalEvents.push('oxygen_low');
                    this.addCriticalEvent('Dangerous oxygen levels - SCBA required', time);
                }
                
                // Structure threat
                if (this.currentState.spreadRadius >= 20 && !this.criticalEvents.includes('structure_threat')) {
                    this.criticalEvents.push('structure_threat');
                    this.addCriticalEvent('Fire threatens structural integrity', time);
                }
                
                // Visibility loss
                if (this.currentState.visibility <= 10 && !this.criticalEvents.includes('visibility_lost')) {
                    this.criticalEvents.push('visibility_lost');
                    this.addCriticalEvent('Zero visibility conditions', time);
                }
            }

            addCriticalEvent(description, time) {
                // This will be used for dynamic question generation
                console.log(`CRITICAL EVENT at ${Math.floor(time/60)}:${String(time%60).padStart(2,'0')} - ${description}`);
            }

            // Apply suppression agent
            applySuppression(agent, duration) {
                const effectiveness = this.physicsParams.suppressionEffectiveness[agent] || 0;
                
                if (effectiveness < 0.3 && agent === 'water' && (this.fireType === 'electrical' || this.fireType === 'fuel')) {
                    // Wrong agent - make fire worse
                    this.currentState.spreadRadius *= 1.5;
                    this.addCriticalEvent(`WARNING: ${agent} on ${this.fireType} fire - situation worsened!`, this.currentState.timeElapsed);
                    return { success: false, consequence: 'fire_spread' };
                }
                
                // Effective suppression
                const suppressionPower = effectiveness * duration;
                this.currentState.temperature *= (1 - suppressionPower * 0.1);
                this.currentState.smokeLevel *= (1 - suppressionPower * 0.05);
                
                if (suppressionPower > 0.8) {
                    this.addCriticalEvent(`Fire suppressed with ${agent}`, this.currentState.timeElapsed);
                    return { success: true, effectiveness: effectiveness };
                }
                
                return { success: false, effectiveness: effectiveness, partial: true };
            }

            // Get current threat level
            getThreatLevel() {
                const temp = this.currentState.temperature;
                const spread = this.currentState.spreadRadius;
                const oxygen = this.currentState.oxygenLevel;
                
                if (temp >= this.physicsParams.flashoverTemp || spread >= 30 || oxygen <= 12) {
                    return 'CRITICAL';
                } else if (temp >= 800 || spread >= 15 || oxygen <= 16) {
                    return 'HIGH';
                } else if (temp >= 500 || spread >= 8) {
                    return 'MODERATE';
                } else {
                    return 'LOW';
                }
            }

            // Generate realistic decision points based on current state
            generateDecisionPoint() {
                const threat = this.getThreatLevel();
                const time = Math.floor(this.currentState.timeElapsed / 60);
                
                const decisionPoints = {
                    'LOW': [
                        'What is your assessment priority?',
                        'How should you approach this fire?',
                        'What suppression preparation is needed?'
                    ],
                    'MODERATE': [
                        'Fire is spreading - immediate action required!',
                        'Smoke is building - what is your ventilation decision?',
                        'Choose your suppression agent quickly!'
                    ],
                    'HIGH': [
                        'DANGER: Fire approaching flashover conditions!',
                        'Oxygen levels dropping - crew safety decision needed!',
                        'Multiple compartments threatened - strategic priority?'
                    ],
                    'CRITICAL': [
                        'FLASHOVER IMMINENT - Emergency action required!',
                        'ABANDON COMPARTMENT or continue firefighting?',
                        'MAYDAY situation - immediate command decision!'
                    ]
                };
                
                return decisionPoints[threat][Math.floor(Math.random() * decisionPoints[threat].length)];
            }
        }

        // ==================== DQN QUESTION GENERATION SYSTEM ====================
        
        class DQNQuestionGenerator {
            constructor() {
                this.userPerformance = {
                    decisionSpeed: 1.0, // Multiplier (1.0 = average)
                    accuracy: 0.75, // Success rate
                    weakAreas: [], // Areas needing improvement
                    strengths: [], // Areas of competence
                    totalScenarios: 0,
                    averageTime: 45 // seconds per decision
                };
                this.difficultyLevel = 1; // 1-5 scale
                this.questionTemplates = this.initializeQuestionTemplates();
            }

            initializeQuestionTemplates() {
                return {
                    assessment: {
                        easy: [
                            {
                                template: "Visual assessment shows {fireDescription}. What fire class is this?",
                                options: ["Class A - Ordinary combustibles", "Class B - Flammable liquids", "Class C - Electrical", "Class D - Metals"],
                                correctIndex: null, // Set based on fire type
                                timeLimit: 30
                            },
                            {
                                template: "Temperature {temperature}¬∞F, oxygen {oxygenLevel}%. Crew safety status?",
                                options: ["Safe to proceed", "SCBA recommended", "SCBA required", "Evacuate immediately"],
                                correctIndex: null,
                                timeLimit: 25
                            }
                        ],
                        medium: [
                            {
                                template: "Fire spread {spreadRadius} feet in {timeElapsed} minutes. Suppression window?",
                                options: ["Plenty of time", "15 minutes remaining", "5 minutes critical", "Immediate action required"],
                                correctIndex: null,
                                timeLimit: 20
                            },
                            {
                                template: "Visibility {visibility}%, toxic gases increasing. Decision priority?",
                                options: ["Continue firefighting", "Improve ventilation", "Evacuate personnel", "Switch tactics"],
                                correctIndex: null,
                                timeLimit: 15
                            }
                        ],
                        hard: [
                            {
                                template: "{threatLevel} conditions, flashover in {timeToFlashover} seconds. Command decision?",
                                options: ["Continue suppression", "Evacuate compartment", "Emergency flooding", "Abandon ship prep"],
                                correctIndex: null,
                                timeLimit: 10
                            }
                        ]
                    },
                    suppression: {
                        easy: [
                            {
                                template: "{fireType} fire confirmed. Best suppression agent?",
                                options: ["Water spray", "CO2", "Foam", "Dry chemical"],
                                correctIndex: null,
                                timeLimit: 25
                            }
                        ],
                        medium: [
                            {
                                template: "Applied {wrongAgent} - fire spread! Correct action?",
                                options: ["Continue same agent", "Switch to {correctAgent}", "Evacuate area", "Emergency ventilation"],
                                correctIndex: 1,
                                timeLimit: 15
                            }
                        ],
                        hard: [
                            {
                                template: "Limited suppression, multiple fires. Strategic priority?",
                                options: ["Attack largest fire", "Protect critical systems", "Create firebreaks", "Coordinate evacuation"],
                                correctIndex: 1,
                                timeLimit: 12
                            }
                        ]
                    }
                };
            }

            // Generate question based on current fire progression
            generateDynamicQuestion(fireProgression, scenarioContext) {
                const state = fireProgression.currentState;
                const threat = fireProgression.getThreatLevel();
                const timeElapsed = Math.floor(state.timeElapsed / 60);
                
                // Select question type based on current situation
                let questionType = 'assessment';
                if (state.timeElapsed > 120) { // After 2 minutes, focus on suppression
                    questionType = Math.random() > 0.4 ? 'suppression' : 'assessment';
                }
                
                const difficulty = this.calculateDynamicDifficulty(threat);
                const template = this.selectDynamicTemplate(questionType, difficulty);
                
                return this.populateDynamicTemplate(template, fireProgression, scenarioContext);
            }

            calculateDynamicDifficulty(threatLevel) {
                const threatDifficulty = {
                    'LOW': 1,
                    'MODERATE': 2, 
                    'HIGH': 3,
                    'CRITICAL': 4
                }[threatLevel] || 1;
                
                // Adjust for user performance
                const performanceBonus = this.userPerformance.accuracy > 0.85 ? 1 : 0;
                return Math.min(3, threatDifficulty + performanceBonus);
            }

            selectDynamicTemplate(questionType, difficulty) {
                const difficultyMap = { 1: 'easy', 2: 'medium', 3: 'hard' };
                const level = difficultyMap[difficulty] || 'easy';
                const templates = this.questionTemplates[questionType][level];
                return templates[Math.floor(Math.random() * templates.length)];
            }

            populateDynamicTemplate(template, fireProgression, scenarioContext) {
                const state = fireProgression.currentState;
                let text = template.template;
                
                // Dynamic replacements based on actual fire state
                const replacements = {
                    '{fireDescription}': this.getFireDescription(fireProgression.fireType, state),
                    '{temperature}': Math.round(state.temperature),
                    '{oxygenLevel}': Math.round(state.oxygenLevel),
                    '{spreadRadius}': Math.round(state.spreadRadius),
                    '{timeElapsed}': Math.floor(state.timeElapsed / 60),
                    '{visibility}': Math.round(state.visibility),
                    '{threatLevel}': fireProgression.getThreatLevel(),
                    '{timeToFlashover}': this.calculateTimeToFlashover(fireProgression),
                    '{fireType}': fireProgression.fireType,
                    '{wrongAgent}': this.getWrongAgent(fireProgression.fireType),
                    '{correctAgent}': this.getCorrectAgent(fireProgression.fireType)
                };
                
                // Apply all replacements
                Object.entries(replacements).forEach(([placeholder, value]) => {
                    text = text.replace(new RegExp(placeholder.replace(/[{}]/g, '\\$&'), 'g'), value);
                });
                
                // Determine correct answer dynamically
                const correctIndex = this.determineCorrectAnswer(template, fireProgression);
                const adjustedTimeLimit = this.adjustTimeForPerformance(template.timeLimit);
                
                return {
                    question: text,
                    options: template.options.map(opt => this.replaceOptionPlaceholders(opt, replacements)),
                    correctIndex: correctIndex,
                    timeLimit: adjustedTimeLimit,
                    explanation: this.generateExplanation(fireProgression, correctIndex),
                    difficulty: this.calculateDynamicDifficulty(fireProgression.getThreatLevel())
                };
            }

            replaceOptionPlaceholders(option, replacements) {
                let result = option;
                Object.entries(replacements).forEach(([placeholder, value]) => {
                    result = result.replace(new RegExp(placeholder.replace(/[{}]/g, '\\$&'), 'g'), value);
                });
                return result;
            }

            determineCorrectAnswer(template, fireProgression) {
                const fireType = fireProgression.fireType;
                const state = fireProgression.currentState;
                
                // Fire class identification
                if (template.template.includes("fire class")) {
                    const fireClasses = { 'electrical': 2, 'fuel': 1, 'cooking': 1, 'materials': 0 };
                    return fireClasses[fireType] || 0;
                }
                
                // Crew safety assessment
                if (template.template.includes("Crew safety")) {
                    if (state.oxygenLevel < 16) return 3; // Evacuate
                    if (state.oxygenLevel < 18 || state.visibility < 30) return 2; // SCBA required
                    if (state.temperature > 500) return 1; // SCBA recommended
                    return 0; // Safe to proceed
                }
                
                // Suppression window
                if (template.template.includes("Suppression window")) {
                    const timeToFlashover = this.calculateTimeToFlashover(fireProgression);
                    if (timeToFlashover < 300) return 3; // Immediate
                    if (timeToFlashover < 600) return 2; // 5 minutes
                    if (timeToFlashover < 900) return 1; // 15 minutes
                    return 0; // Plenty of time
                }
                
                // Best suppression agent
                if (template.template.includes("Best suppression")) {
                    const agents = { 'electrical': 1, 'fuel': 2, 'cooking': 3, 'materials': 0 };
                    return agents[fireType] || 0;
                }
                
                return template.correctIndex || 0;
            }

            // Helper methods (simplified versions)
            getFireDescription(fireType, state) {
                const intensity = state.temperature > 800 ? 'intense' : 'moderate';
                const descriptions = {
                    'electrical': `sparking and arcing, ${intensity} heat`,
                    'fuel': `liquid fuel burning, spread pattern visible`,
                    'cooking': `oil fire, ${state.temperature}¬∞F temperature`,
                    'materials': `solid combustibles, ${intensity} flames`
                };
                return descriptions[fireType] || descriptions['materials'];
            }

            calculateTimeToFlashover(fireProgression) {
                const current = fireProgression.currentState.temperature;
                const flashover = fireProgression.physicsParams.flashoverTemp;
                const riseRate = fireProgression.physicsParams.tempRiseRate;
                
                if (current >= flashover) return 0;
                return Math.max(0, Math.round((flashover - current) / riseRate * 60));
            }

            getWrongAgent(fireType) {
                return { 'electrical': 'water', 'fuel': 'water', 'cooking': 'water', 'materials': 'CO2' }[fireType] || 'water';
            }

            getCorrectAgent(fireType) {
                return { 'electrical': 'CO2', 'fuel': 'foam', 'cooking': 'Class K', 'materials': 'water' }[fireType] || 'water';
            }

            adjustTimeForPerformance(baseTime) {
                return Math.round(baseTime / this.userPerformance.decisionSpeed);
            }

            generateExplanation(fireProgression, correctIndex) {
                const fireType = fireProgression.fireType;
                const threat = fireProgression.getThreatLevel();
                return `${fireType} fires at ${threat} threat level require specific protocols based on physics and safety standards.`;
            }

            // Update performance tracking
            recordPerformance(responseTime, correct, category) {
                this.userPerformance.totalScenarios++;
                
                // Update running averages
                const n = this.userPerformance.totalScenarios;
                this.userPerformance.accuracy = ((n-1) * this.userPerformance.accuracy + (correct ? 1 : 0)) / n;
                this.userPerformance.averageTime = ((n-1) * this.userPerformance.averageTime + responseTime) / n;
                this.userPerformance.decisionSpeed = 45 / this.userPerformance.averageTime;
                
                // Track weak areas
                if (!correct && !this.userPerformance.weakAreas.includes(category)) {
                    this.userPerformance.weakAreas.push(category);
                }
            }
        }

        // Initialize DQN system after classes are defined
        dqnQuestionGenerator = new DQNQuestionGenerator();

        // Display scenario
        function displayScenario(scenario) {
            const display = document.getElementById('scenarioDisplay');
            display.innerHTML = `
                <div class="scenario-display">
                    <div class="scenario-context">
                        <h3>üö® ${scenario.title}</h3>
                        <div class="scenario-details">
                            <div class="detail-item">
                                <span class="detail-label">Location:</span>
                                <span>${scenario.location}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Fire Type:</span>
                                <span>${scenario.fireType}</span>
                            </div>
                        </div>
                        <p><strong>Situation:</strong> ${scenario.situation}</p>
                    </div>
                    
                    <div class="response-options">
                        <h4>‚ö° ${scenario.initialDecision}</h4>
                        <div class="options-grid">
                            ${scenario.options.map((option, index) => `
                                <div class="response-option" onclick="selectScenarioAnswer(${index})">
                                    <input type="radio" name="scenarioChoice" value="${index}" id="option${index}">
                                    <label for="option${index}">${option}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="scenario-actions">
                        <button onclick="submitScenarioAnswer(${scenario.correct}, '${scenario.explanation}')" class="scenario-btn primary" id="submitScenarioBtn" disabled>Submit Decision</button>
                        <button onclick="generateRandomScenario()" class="scenario-btn secondary">Try Different Scenario</button>
                    </div>
                </div>
            `;
        }

        // Select scenario answer
        window.selectScenarioAnswer = function(index) {
            selectedAnswer = index;
            document.querySelectorAll('.response-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelectorAll('.response-option')[index].classList.add('selected');
            document.getElementById('submitScenarioBtn').disabled = false;
        }

        // Submit scenario answer
        window.submitScenarioAnswer = function(correctAnswer, explanation) {
            if (selectedAnswer === null) return;
            
            const isCorrect = selectedAnswer === correctAnswer;
            const display = document.getElementById('scenarioDisplay');
            
            display.innerHTML += `
                <div class="ai-analysis">
                    <h4>${isCorrect ? '‚úÖ Excellent Decision!' : '‚ùå Poor Tactical Choice'}</h4>
                    <div class="analysis-explanation">
                        <p><strong>Explanation:</strong> ${explanation}</p>
                        ${isCorrect ? 
                            '<p><strong>Outcome:</strong> Your quick thinking and proper suppression agent selection contained the fire with minimal damage. Crew safety maintained.</p>' :
                            '<p><strong>Outcome:</strong> Poor suppression choice led to fire escalation. In a real scenario, this could result in injuries and vessel loss.</p>'
                        }
                    </div>
                </div>
            `;
        }

        // Assessment Mode Functions
        function initializeAssessment() {
            console.log('Initializing assessment...');
            try {
                assessmentQuestions = getAssessmentQuestions();
                console.log('Got assessment questions:', assessmentQuestions.length);
                currentQuestionIndex = 0;
                score = 0;
                selectedAnswer = null;
                console.log('About to show assessment interface');
                showAssessmentInterface();
                console.log('Assessment interface shown');
            } catch (error) {
                console.error('Error in initializeAssessment:', error);
                alert('Error initializing assessment: ' + error.message);
            }
        }

        function showAssessmentInterface() {
            const content = document.getElementById('assessmentContent');
            content.innerHTML = `
                <div class="assessment-interface">
                    <div class="assessment-header">
                        <h2>üìã DCA Fire Response Assessment</h2>
                        <p>Test your knowledge with realistic fire emergency scenarios. Each question is based on actual procedures and real-world incidents.</p>
                        <button onclick="returnToMenu()" class="assessment-btn secondary">Back to Menu</button>
                        <button onclick="startQuiz()" class="assessment-btn primary">Begin Assessment</button>
                    </div>
                    
                    <div id="quizArea" style="display: none;">
                        <!-- Questions will be loaded here -->
                    </div>
                </div>
            `;
        }

        // Start the quiz
        window.startQuiz = function() {
            document.querySelector('.assessment-header button').style.display = 'none';
            document.getElementById('quizArea').style.display = 'block';
            
            // Initialize a DQN scenario for the assessment if not already done
            if (!currentScenario || !currentFireProgression) {
                generateRandomScenario();
            }
            
            showQuestion();
        }

        // Get assessment questions
        function getAssessmentQuestions() {
            return [
                {
                    question: "Engine room fire reported with heavy smoke. What is your first action as DCA?",
                    options: [
                        "Send investigation team to assess situation",
                        "Sound General Quarters immediately",
                        "Activate CO2 flooding system",
                        "Call Coast Guard for assistance"
                    ],
                    correct: 1,
                    explanation: "General Quarters must be sounded immediately to ensure maximum crew response and establish proper command structure for fire fighting."
                },
                {
                    question: "Galley deep fryer fire spreads to ventilation system. What suppression agent should be used?",
                    options: [
                        "Water spray to cool burning oil",
                        "CO2 to displace oxygen",
                        "Class K wet chemical system",
                        "Foam to smother flames"
                    ],
                    correct: 2,
                    explanation: "Class K wet chemical suppression is specifically designed for cooking oil fires and prevents re-ignition by cooling oil below auto-ignition temperature."
                },
                {
                    question: "Electrical fire in bridge navigation equipment during restricted visibility. Priority action?",
                    options: [
                        "Use water fog for quick suppression",
                        "Isolate power and use CO2 suppression",
                        "Evacuate bridge immediately",
                        "Continue navigation, fight fire later"
                    ],
                    correct: 1,
                    explanation: "Electrical fires require power isolation to prevent electrocution, followed by CO2 which doesn't conduct electricity or damage electronics."
                },
                {
                    question: "Multiple compartment fire with limited crew. What is your strategic priority?",
                    options: [
                        "Fight all fires simultaneously",
                        "Focus on largest fire first",
                        "Prevent spread to critical systems",
                        "Abandon ship preparation"
                    ],
                    correct: 2,
                    explanation: "With limited resources, preventing fire spread to critical systems (propulsion, power, life safety) takes priority over saving already burning spaces."
                },
                {
                    question: "Fuel oil fire in engine room with crew trapped. Immediate action?",
                    options: [
                        "Activate fixed CO2 system",
                        "Personnel rescue first, then suppression",
                        "Isolate fuel source immediately",
                        "Use water spray to create escape path"
                    ],
                    correct: 1,
                    explanation: "Life safety always takes priority. Personnel must be rescued before any suppression action that could endanger trapped crew members."
                }
            ];
        }

        // Show current question - now uses DQN dynamic questions
        function showQuestion() {
            // Check if we should show final results
            if (currentQuestionIndex >= 10) { // Limit to 10 DQN questions
                showFinalResults();
                return;
            }

            // Generate dynamic question based on current fire progression
            if (!currentFireProgression || !dqnQuestionGenerator) {
                console.error('DQN system not initialized');
                return;
            }

            const question = dqnQuestionGenerator.generateDynamicQuestion(currentFireProgression, currentScenario);
            currentDQNQuestion = question; // Store for use in selectAnswer
            
            // Advance fire progression slightly for next question
            currentFireProgression.updateProgression(30); // 30 seconds advance
            
            const quizArea = document.getElementById('quizArea');
            
            quizArea.innerHTML = `
                <div class="question-container">
                    <div class="question-header">
                        <h3>üö® Scenario: ${currentScenario.title}</h3>
                        <p><strong>Location:</strong> ${currentScenario.location}</p>
                        <div class="fire-status">
                            <span>üî• Temperature: ${Math.round(currentFireProgression.currentState.temperature)}¬∞F</span>
                            <span>üí® Oxygen: ${Math.round(currentFireProgression.currentState.oxygenLevel)}%</span>
                            <span>‚è±Ô∏è Time: ${Math.floor(currentFireProgression.currentState.timeElapsed / 60)}:${String(Math.floor(currentFireProgression.currentState.timeElapsed % 60)).padStart(2, '0')}</span>
                        </div>
                        <h4>Question ${currentQuestionIndex + 1} of 10</h4>
                    </div>
                    
                    <div class="question-text">
                        <p>${question.question}</p>
                    </div>
                    
                    <div class="answer-options">
                        ${question.options.map((option, index) => `
                            <button class="answer-option" onclick="selectAnswer(${index})">
                                <span class="option-letter">${String.fromCharCode(65 + index)}</span>
                                <span class="option-text">${option}</span>
                            </button>
                        `).join('')}
                    </div>
                    
                    <div class="question-controls">
                        <button onclick="submitAnswer()" class="assessment-btn primary" id="submitBtn" disabled>Submit Answer</button>
                        ${currentQuestionIndex > 0 ? '<button onclick="previousQuestion()" class="assessment-btn secondary">Previous</button>' : ''}
                    </div>
                </div>
            `;
        }

        // Select answer
        window.selectAnswer = function(index) {
            selectedAnswer = index;
            document.querySelectorAll('.answer-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelectorAll('.answer-option')[index].classList.add('selected');
            document.getElementById('submitBtn').disabled = false;
        }

        // Submit answer
        window.submitAnswer = function() {
            if (selectedAnswer === null || !currentDQNQuestion) return;
            
            const question = currentDQNQuestion;
            const isCorrect = selectedAnswer === question.correctIndex;
            
            if (isCorrect) score++;
            
            // Record performance in DQN system
            const responseTime = 10; // You could implement actual timing
            dqnQuestionGenerator.recordPerformance(responseTime, isCorrect, 'assessment');
            
            showAnswerFeedback(question, isCorrect);
        }

        // Show answer feedback
        function showAnswerFeedback(question, isCorrect) {
            const quizArea = document.getElementById('quizArea');
            
            quizArea.innerHTML = `
                <div class="question-container">
                    <div class="feedback-result ${isCorrect ? 'correct' : 'incorrect'}">
                        <h3>${isCorrect ? '‚úÖ Correct!' : '‚ùå Incorrect'}</h3>
                        <p><strong>Scenario:</strong> ${currentScenario.title} - ${currentScenario.location}</p>
                    </div>
                    
                    <div class="correct-answer">
                        <h4>Correct Answer:</h4>
                        <p><strong>${String.fromCharCode(65 + question.correctIndex)}:</strong> ${question.options[question.correctIndex]}</p>
                    </div>
                    
                    <div class="explanation">
                        <h4>Explanation:</h4>
                        <p>${question.explanation}</p>
                    </div>
                    
                    <div class="fire-progression-update">
                        <h4>üî• Fire Status Update:</h4>
                        <p>Temperature: ${Math.round(currentFireProgression.currentState.temperature)}¬∞F | 
                           Oxygen: ${Math.round(currentFireProgression.currentState.oxygenLevel)}% | 
                           Spread: ${Math.round(currentFireProgression.currentState.spreadRadius)} ft</p>
                    </div>
                    
                    <div class="question-controls">
                        <button onclick="nextQuestion()" class="assessment-btn primary">
                            ${currentQuestionIndex < 9 ? 'Next Question' : 'View Results'}
                        </button>
                    </div>
                </div>
            `;
        }

        // Next question
        window.nextQuestion = function() {
            currentQuestionIndex++;
            selectedAnswer = null;
            showQuestion();
        }

        // Previous question
        window.previousQuestion = function() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                selectedAnswer = null;
                showQuestion();
            }
        }

        // Show final results
        function showFinalResults() {
            const totalQuestions = 10; // DQN assessment uses 10 questions
            const percentage = Math.round((score / totalQuestions) * 100);
            const quizArea = document.getElementById('quizArea');
            
            let performanceLevel = '';
            if (percentage >= 90) performanceLevel = 'Expert Level';
            else if (percentage >= 75) performanceLevel = 'Proficient';
            else if (percentage >= 60) performanceLevel = 'Developing';
            else performanceLevel = 'Needs Improvement';
            
            // Get DQN performance metrics
            const dqnPerformance = dqnQuestionGenerator ? dqnQuestionGenerator.userPerformance : null;
            
            quizArea.innerHTML = `
                <div class="results-card">
                    <h2>üéØ DQN Fire Response Assessment Complete!</h2>
                    <div class="scenario-summary">
                        <h3>üìã Scenario Completed: ${currentScenario.title}</h3>
                        <p><strong>Location:</strong> ${currentScenario.location}</p>
                        <p><strong>Fire Type:</strong> ${currentScenario.fireType}</p>
                    </div>
                    
                    <div class="score-display">${percentage}%</div>
                    <div class="score-breakdown">
                        <p>${score} out of ${totalQuestions} correct</p>
                        <p><strong>Performance Level: ${performanceLevel}</strong></p>
                        ${dqnPerformance ? `
                            <p><strong>DQN Accuracy:</strong> ${(dqnPerformance.accuracy * 100).toFixed(1)}%</p>
                            <p><strong>Average Decision Time:</strong> ${dqnPerformance.averageTime.toFixed(1)}s</p>
                        ` : ''}
                    </div>
                    
                    <div class="fire-final-status">
                        <h4>üî• Final Fire Status:</h4>
                        <p>Temperature: ${Math.round(currentFireProgression.currentState.temperature)}¬∞F | 
                           Oxygen: ${Math.round(currentFireProgression.currentState.oxygenLevel)}% | 
                           Spread: ${Math.round(currentFireProgression.currentState.spreadRadius)} ft</p>
                        <p><strong>Threat Level:</strong> ${currentFireProgression.getThreatLevel()}</p>
                    </div>
                    
                    <div class="feedback-message">
                        ${percentage >= 80 ? 
                            'Excellent performance! You demonstrate strong understanding of fire response procedures and tactical decision-making in realistic scenarios.' :
                            percentage >= 60 ?
                            'Good foundation with room for improvement. Review fire classification and suppression procedures in dynamic situations.' :
                            'Additional training recommended. Focus on fire fundamentals and emergency response procedures under pressure.'
                        }
                    </div>
                    
                    <div class="results-actions">
                        <button onclick="initializeAssessment()" class="assessment-btn secondary">Retake Assessment</button>
                        <button onclick="returnToMenu()" class="assessment-btn primary">Return to Menu</button>
                    </div>
                </div>
            `;
        }

        // Initialize feedback integration if available
        if (window.startDCAFeedbackSession) {
            console.log('DCA Feedback Integration Available');
        } else {
            console.log('Running in standalone mode');
        }
    </script>
</body>
</html>